
> my-app@0.1.0 lint
> eslint --format json

[{"filePath":"/home/quan/Downloads/Agent-AI/app/api/admin/users/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":119,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":119,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3346,3349],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3346,3349],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":166,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4522,4525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4522,4525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":179,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":179,"endColumn":48},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5228,5231],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5228,5231],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { clerkClient } from \"@clerk/nextjs/server\";\nimport { requireRole } from \"@/lib/auth-utils\";\nimport { db } from \"@/lib/db\";\n\n/**\n * @swagger\n * /api/admin/users:\n *   post:\n *     summary: Create a new user (Admin only)\n *     description: Admin creates user via Clerk and sets role/department in metadata\n *     tags:\n *       - Admin\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - email\n *               - password\n *               - role\n *             properties:\n *               email:\n *                 type: string\n *               password:\n *                 type: string\n *               firstName:\n *                 type: string\n *               lastName:\n *                 type: string\n *               role:\n *                 type: string\n *                 enum: [Admin, Manager, Sales, Technician]\n *               departmentId:\n *                 type: string\n *     responses:\n *       201:\n *         description: User created successfully\n *       403:\n *         description: Forbidden - Admin only\n */\nexport async function POST(req: NextRequest) {\n  try {\n    // USER ONBOARDING (Phương án A - Mục 6): Only Admin can create users\n    await requireRole([\"Admin\"]);\n\n    const body = await req.json();\n    const { email, password, firstName, lastName, role, departmentId } = body;\n\n    if (!email || !password || !role) {\n      return NextResponse.json(\n        { error: \"email, password, and role are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Validate role\n    const validRoles = [\"Admin\", \"Manager\", \"Sales\", \"Technician\"];\n    if (!validRoles.includes(role)) {\n      return NextResponse.json(\n        { error: `Invalid role.Must be one of: ${validRoles.join(\", \")} ` },\n        { status: 400 }\n      );\n    }\n\n    // If role is Manager or Technician, department is required\n    if ((role === \"Manager\" || role === \"Technician\") && !departmentId) {\n      return NextResponse.json(\n        { error: `Department is required for ${role} role` },\n        { status: 400 }\n      );\n    }\n\n    // Verify department exists if provided\n    if (departmentId) {\n      const department = await db.departments.findUnique({\n        where: { id: departmentId },\n      });\n\n      if (!department) {\n        return NextResponse.json(\n          { error: \"Department not found\" },\n          { status: 404 }\n        );\n      }\n    }\n\n    // Create user in Clerk with metadata\n    const client = await clerkClient();\n    const clerkUser = await client.users.createUser({\n      emailAddress: [email],\n      password: password,\n      firstName: firstName,\n      lastName: lastName,\n      publicMetadata: {\n        role: role,\n        department_id: departmentId || null,\n      },\n    });\n\n    // Webhook will automatically create user in our database\n    // with role and department from metadata\n\n    return NextResponse.json(\n      {\n        success: true,\n        message: \"User created successfully. They can now sign in.\",\n        user: {\n          id: clerkUser.id,\n          email: email,\n          role: role,\n          departmentId: departmentId,\n        },\n      },\n      { status: 201 }\n    );\n  } catch (error: any) {\n    console.error(\"Error creating user:\", error);\n\n    if (error.message?.includes(\"Forbidden\") || error.message?.includes(\"Unauthorized\")) {\n      return NextResponse.json(\n        { error: \"Only Admin can create users\" },\n        { status: 403 }\n      );\n    }\n\n    // Clerk-specific errors\n    if (error.errors) {\n      return NextResponse.json(\n        { error: error.errors[0]?.message || \"Failed to create user in Clerk\" },\n        { status: 400 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to create user\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/admin/users:\n *   get:\n *     summary: Get all users (Admin only)\n *     description: Returns list of all users with their roles and departments\n *     tags:\n *       - Admin\n *     responses:\n *       200:\n *         description: List of users\n *       403:\n *         description: Forbidden\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: NextRequest) {\n  try {\n    await requireRole([\"Admin\"]);\n\n    const paginationParams = getPaginationParams(req);\n\n    const usersResult = await db.$queryRaw<any[]>`\n      SELECT \n        u.*,\n        COUNT(*) OVER() as full_count,\n        d.name as department_name\n      FROM public.users u\n      LEFT JOIN public.departments d ON u.department_id = d.id\n      ORDER BY u.email ASC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(usersResult[0]?.full_count || 0);\n\n    const users = usersResult.map(({ full_count, department_name, ...rest }) => ({\n      ...rest,\n      departments: rest.department_id ? {\n        id: rest.department_id,\n        name: department_name,\n      } : null,\n    }));\n\n    return NextResponse.json(formatPaginatedResponse(users, totalCount, paginationParams));\n  } catch (error: any) {\n    console.error(\"Error fetching users:\", error);\n\n    if (error.message?.includes(\"Forbidden\") || error.message?.includes(\"Unauthorized\")) {\n      return NextResponse.json(\n        { error: \"Only Admin can view all users\" },\n        { status: 403 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to fetch users\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/calendar-events/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1214,1217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1214,1217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":55,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":55,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":58,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":80,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":80,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\n\n/**\n * @swagger\n * /api/calendar-events:\n *   get:\n *     summary: List calendar events\n *     tags: [Calendar]\n *     responses:\n *       200:\n *         description: List of events\n *   post:\n *     summary: Create a calendar event\n *     tags: [Calendar]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             properties:\n *               title:\n *                 type: string\n *               start_time:\n *                 type: string\n *                 format: date-time\n *               end_time:\n *                 type: string\n *                 format: date-time\n *               description:\n *                 type: string\n *               created_by_user_id:\n *                 type: string\n *     responses:\n *       201:\n *         description: Event created\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(request: Request) {\n  try {\n    const paginationParams = getPaginationParams(request, 20);\n\n    const eventsResult = await prisma.$queryRaw<any[]>`\n      SELECT \n        *,\n        COUNT(*) OVER() as full_count\n      FROM public.calendar_events\n      ORDER BY start_time ASC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(eventsResult[0]?.full_count || 0);\n    const events = eventsResult.map(({ full_count, ...rest }) => rest);\n\n    return NextResponse.json(formatPaginatedResponse(events, totalCount, paginationParams));\n  } catch (error) {\n    return NextResponse.json({ error: \"Failed to fetch events\" }, { status: 500 });\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    // Logic: Trong tương lai, đoạn này sẽ gọi Google Calendar API để tạo event\n    // const googleEvent = await googleCalendar.events.insert(...)\n\n    const newEvent = await prisma.calendar_events.create({\n      data: {\n        title: body.title,\n        start_time: new Date(body.start_time),\n        end_time: new Date(body.end_time),\n        description: body.description,\n        created_by_user_id: body.created_by_user_id,\n        // google_event_id: googleEvent.id // Lưu lại ID của Google\n      }\n    });\n    return NextResponse.json(newEvent, { status: 201 });\n  } catch (error) {\n    return NextResponse.json({ error: \"Failed to create event\" }, { status: 500 });\n  }\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/chat/internal/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/chat/messages/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getCurrentUserWithRole' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1677,1680],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1677,1680],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":71,"column":44,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":54},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchParams' is assigned a value but never used.","line":87,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":87,"endColumn":25}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\nimport { getCurrentUserWithRole } from \"@/lib/auth-utils\";\nimport { handleApiError } from \"@/lib/api-helper\";\n\n/**\n * @swagger\n * /api/chat/messages:\n *   get:\n *     summary: List messages in a session\n *     tags: [Chat]\n *     parameters:\n *       - in: query\n *         name: session_id\n *         schema:\n *           type: string\n *         description: ID of the chat session\n *     responses:\n *       200:\n *         description: List of messages\n *   post:\n *     summary: Add a new message\n *     tags: [Chat]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - session_id\n *               - role\n *               - content\n *             properties:\n *               session_id:\n *                 type: string\n *                 format: uuid\n *               role:\n *                 type: string\n *                 enum: [user, assistant]\n *               content:\n *                 type: string\n *     responses:\n *       201:\n *         description: Message created\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const session_id = searchParams.get(\"session_id\");\n\n    if (!session_id) {\n      return NextResponse.json({ error: \"session_id is required\" }, { status: 400 });\n    }\n\n    const paginationParams = getPaginationParams(request, 50);\n\n    const messagesResult = await prisma.$queryRaw<any[]>`\n      SELECT \n        *,\n        COUNT(*) OVER() as full_count\n      FROM public.chat_messages\n      WHERE session_id = ${session_id}\n      ORDER BY timestamp ASC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(messagesResult[0]?.full_count || 0);\n    const messages = messagesResult.map(({ full_count, ...rest }) => rest);\n\n    return NextResponse.json(formatPaginatedResponse(messages, totalCount, paginationParams));\n  } catch (error) {\n    return handleApiError(error, \"Get Messages Error\");\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n\n    if (!body.session_id || !body.role || !body.content) {\n      return NextResponse.json({ error: \"Missing required fields\" }, { status: 400 });\n    }\n\n    const { searchParams } = new URL(request.url); // Extract params if needed\n\n    console.log(`[Messages API] POST received.Session: ${body.session_id}, Content: \"${body.content.substring(0, 20)}...\"`);\n\n    // --- DEDUPLICATION CHECK ---\n    // Fetch last 5 messages for this session to compare in memory\n    const recentMessages = await prisma.chat_messages.findMany({\n      where: {\n        session_id: body.session_id,\n        role: body.role, // Match role\n      },\n      orderBy: {\n        timestamp: 'desc'\n      },\n      take: 5\n    });\n\n    console.log(`[Messages API] Recent messages found: ${recentMessages.length} `);\n    recentMessages.forEach(m => {\n      console.log(` - ID: ${m.id}, Content: \"${m.content.substring(0, 20)}...\", TimeDiff: ${Date.now() - new Date(m.timestamp).getTime()} ms`);\n    });\n\n    const duplicateMessage = recentMessages.find(msg => {\n      const contentMatch = msg.content.trim() === body.content.trim();\n      const timeMatch = (new Date().getTime() - new Date(msg.timestamp).getTime() < 60000);\n      if (contentMatch && timeMatch) {\n        console.log(`   -> Match found! ID: ${msg.id} `);\n        return true;\n      }\n      return false;\n    });\n\n    if (duplicateMessage) {\n      console.log(`[Messages API] Duplicate detected(Memory Check), skipping creation.ID: ${duplicateMessage.id} `);\n      return NextResponse.json(duplicateMessage, { status: 200 });\n    }\n    // ---------------------------\n\n    const newMessage = await prisma.chat_messages.create({\n      data: {\n        session_id: body.session_id,\n        role: body.role, // 'user' hoặc 'assistant'\n        content: body.content,\n        timestamp: new Date(),\n        retrieved_context: { ...(body.retrieved_context || {}), source: 'messages_api' } // Tag source\n      }\n    });\n\n    return NextResponse.json(newMessage, { status: 201 });\n  } catch (error) {\n    return handleApiError(error, \"Create Message Error\");\n  }\n}\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/chat/n8n/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'uuidv4' is defined but never used.","line":4,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'clientMessageId' is defined but never used.","line":46,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":214,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":214,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6621,6624],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6621,6624],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\nimport { getCurrentUserWithRole } from \"@/lib/auth-utils\";\nimport { v4 as uuidv4 } from \"uuid\";\nimport { handleApiError } from \"@/lib/api-helper\";\n\n/**\n * @swagger\n * /api/chat/n8n:\n *   post:\n *     summary: Proxy request to n8n webhook (Multi-modal) with persistence\n *     description: Saves message to DB, forwards to n8n, and saves response.\n *     tags: [Chat]\n *     requestBody:\n *       required: true\n *       content:\n *         multipart/form-data:\n *           schema:\n *             type: object\n *             properties:\n *               sessionId:\n *                 type: string\n *               userId:\n *                 type: string\n *               type:\n *                 type: string\n *                 enum: [chat, voice, image]\n *               chatInput:\n *                 type: string\n *               file:\n *                 type: string\n *                 format: binary\n *             required:\n *               - sessionId\n *               - type\n *     responses:\n *       200:\n *         description: Successful response from n8n.\n *       500:\n *         description: Server error.\n */\nexport async function POST(req: NextRequest) {\n  // Define variables outside try block for finally access\n  let sessionId: string | undefined;\n  let userContent: string | undefined;\n  let clientMessageId: string | undefined;\n\n  try {\n    // Get authenticated user (auto-creates if needed)\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json(\n        { error: \"Unauthorized. Please log in.\" },\n        { status: 401 }\n      );\n    }\n\n    const formData = await req.formData();\n    sessionId = formData.get(\"sessionId\") as string;\n    const type = formData.get(\"type\") as string;\n    const chatInput = formData.get(\"chatInput\") as string;\n\n    // 1. Validate inputs\n    if (!sessionId || !type) {\n      return NextResponse.json(\n        { error: \"Missing sessionId or type\" },\n        { status: 400 }\n      );\n    }\n\n    // Use authenticated user's ID\n    const userId = currentUser.id;\n\n    // 3. Ensure Session Exists (Upsert)\n    // Chúng ta thử tìm session trước\n    let session = await prisma.chat_sessions.findUnique({\n      where: { id: sessionId },\n    });\n\n    if (!session) {\n      // Tạo mới session\n      try {\n        session = await prisma.chat_sessions.create({\n          data: {\n            id: sessionId,\n            user_id: userId,\n            summary: chatInput ? chatInput.substring(0, 50) : \"New Conversation\",\n            created_at: new Date(),\n          }\n        });\n      } catch (e) {\n        console.error(\"Failed to create session:\", e);\n        // Nếu lỗi này do userId không tồn tại trong bảng users, ta cần báo lỗi rõ ràng\n        return NextResponse.json(\n          { error: \"Failed to create session. Ensure userId is valid.\" },\n          { status: 500 }\n        );\n      }\n    }\n\n    // 4. Save User Message - REMOVED (User requested N8N to handle saving)\n    // We only prepare the content variable for N8N forwarding if needed (it uses chatInput/formData directly)\n    userContent = chatInput || \"\";\n    if (type === \"voice\") userContent = \"[Voice Message]\";\n    if (type === \"image\") userContent = \"[Image Upload]\";\n\n    // OPTIONAL: If N8N fails to save the user message, there is a risk of data loss here.\n    // The user has explicitly accepted this risk to avoid duplication.\n\n    // 5. Forward to n8n\n    let n8nUrl = process.env.N8N_HOST;\n    if (type === \"image\" && process.env.N8N_WEBHOOK_IMAGE) {\n      n8nUrl = process.env.N8N_WEBHOOK_IMAGE;\n    } else {\n      n8nUrl = process.env.N8N_MAIN_RAG_WEBHOOK_URL;\n    }\n\n    if (!n8nUrl) {\n      // Development Fallback: Nếu không có n8n, trả về echo để test\n      if (process.env.NODE_ENV === 'development') {\n        const fakeResponse = {\n          text: `[DEV MODE] Received: ${userContent}. (Configure N8N_HOST in .env to use real AI)`\n        };\n\n        // In dev mode without N8N, we MUST save it manually or it won't appear at all.\n        await prisma.chat_messages.create({\n          data: {\n            session_id: sessionId,\n            role: \"user\",\n            content: userContent,\n            timestamp: new Date(),\n            retrieved_context: { source: 'dev_mode' }\n          }\n        });\n\n        await prisma.chat_messages.create({\n          data: {\n            session_id: sessionId,\n            role: \"assistant\",\n            content: fakeResponse.text,\n            timestamp: new Date(),\n          }\n        });\n        return NextResponse.json(fakeResponse);\n      }\n\n      throw new Error(\"N8N Webhook URL not configured\");\n    }\n\n    const outgoingFormData = new FormData();\n    // Copy fields for n8n\n    outgoingFormData.append(\"sessionId\", sessionId);\n    outgoingFormData.append(\"type\", type);\n    if (chatInput) outgoingFormData.append(\"chatInput\", chatInput);\n\n    // Nếu có file, cần append đúng cách\n    const file = formData.get(\"file\");\n    if (file) {\n      outgoingFormData.append(\"file\", file);\n    }\n\n    const n8nResponse = await fetch(n8nUrl, {\n      method: \"POST\",\n      body: outgoingFormData,\n    });\n\n    if (!n8nResponse.ok) {\n      // Log text lỗi từ n8n\n      const errText = await n8nResponse.text();\n      throw new Error(`n8n responded with ${n8nResponse.status}: ${errText}`);\n    }\n\n    const text = await n8nResponse.text();\n    let data;\n    try {\n      data = JSON.parse(text);\n    } catch {\n      data = { text: text };\n    }\n\n    // 6. Save AI Response (Keep this as fallback/check)\n    const aiContent = data.output || data.text || data.message || JSON.stringify(data);\n    const citations = data.citations; // Optional\n\n    // --- RESPONSE DEDUPLICATION ---\n    const connection = await prisma.chat_messages.findFirst({\n      where: {\n        session_id: sessionId,\n        role: \"assistant\",\n      },\n      orderBy: {\n        timestamp: 'desc'\n      }\n    });\n\n    if (connection && connection.content === aiContent && (new Date().getTime() - new Date(connection.timestamp).getTime() < 10000)) {\n      console.log(`[n8n API] Duplicate AI response detected (matched DB), skipping save.`);\n    } else {\n      await prisma.chat_messages.create({\n        data: {\n          session_id: sessionId,\n          role: \"assistant\",\n          content: aiContent,\n          timestamp: new Date(),\n          retrieved_context: citations ? JSON.stringify(citations) : undefined\n        }\n      });\n    }\n    // ----------------------------\n\n    return NextResponse.json(data);\n\n  } catch (error: any) {\n    return handleApiError(error, \"Chat API Error\");\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/chat/sessions/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1541,1544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1541,1544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { v4 as uuidv4 } from 'uuid';\nimport { handleApiError } from \"@/lib/api-helper\";\nimport { db as prisma } from \"@/lib/db\";\nimport { getCurrentUserWithRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/chat/sessions:\n *   get:\n *     summary: List chat sessions\n *     tags: [Chat]\n *     parameters:\n *       - in: query\n *         name: user_id\n *         schema:\n *           type: string\n *         description: Filter by User ID\n *     responses:\n *       200:\n *         description: List of sessions\n *   post:\n *     summary: Create a new chat session\n *     tags: [Chat]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - user_id\n *             properties:\n *               user_id:\n *                 type: string\n *                 format: uuid\n *               summary:\n *                 type: string\n *     responses:\n *       201:\n *         description: Session created\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(request: Request) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const paginationParams = getPaginationParams(request);\n\n    // Fetch sessions with latest message in 1 query\n    const sessionsResult = await prisma.$queryRaw<any[]>`\n      SELECT \n        s.*,\n        COUNT(*) OVER() as full_count,\n        (\n          SELECT content \n          FROM public.chat_messages m \n          WHERE m.session_id = s.id \n          ORDER BY m.timestamp DESC \n          LIMIT 1\n        ) as preview\n      FROM public.chat_sessions s\n      WHERE s.user_id = ${currentUser.id}\n      ORDER BY s.created_at DESC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(sessionsResult[0]?.full_count || 0);\n\n    const formattedSessions = sessionsResult.map(session => ({\n      id: session.id,\n      title: session.summary || \"New Chat\",\n      updatedAt: session.created_at,\n      preview: session.preview || \"No messages yet\"\n    }));\n\n    return NextResponse.json(formatPaginatedResponse(formattedSessions, totalCount, paginationParams));\n  } catch (error) {\n    return handleApiError(error, \"Get Sessions Error\");\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const body = await request.json();\n\n    const newSession = await prisma.chat_sessions.create({\n      data: {\n        id: uuidv4(),\n        user_id: currentUser.id,\n        summary: body.summary || \"New Chat\",\n        created_at: new Date()\n      }\n    });\n\n    return NextResponse.json(newSession, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to create session:\", error);\n    return NextResponse.json({ error: \"Failed to create session\" }, { status: 500 });\n  }\n}\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/customers/[id]/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/customers/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":57,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1685,1688],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1685,1688],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":69,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":69,"endColumn":56}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\nimport { getCurrentUserWithRole, requireRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/customers:\n *   get:\n *     summary: Get customers list\n *     description: Admin and Manager can view full customer list. Sales CANNOT view customer list (per requirements).\n *     tags: [Customers]\n *     responses:\n *       200:\n *         description: A list of customers.\n *       403:\n *         description: Forbidden - Sales cannot view customer list\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: Request) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // SALES RESTRICTION (Per requirements): Sales cannot view customer list\n    if (currentUser.role === \"Sales\") {\n      return NextResponse.json(\n        {\n          error:\n            \"Forbidden: Sales role does not have access to customer list\",\n        },\n        { status: 403 }\n      );\n    }\n\n    // Technicians also cannot view customer list\n    if (currentUser.role === \"Technician\") {\n      return NextResponse.json(\n        {\n          error:\n            \"Forbidden: Technicians do not have access to customer list\",\n        },\n        { status: 403 }\n      );\n    }\n\n    const { searchParams } = new URL(req.url);\n    const search = searchParams.get(\"search\");\n    const paginationParams = getPaginationParams(req, 20);\n\n\n    const searchPattern = search ? `%${search}%` : \"%\";\n\n    const customersResult = await prisma.$queryRaw<any[]>`\n      SELECT\n        *,\n        COUNT(*) OVER() as full_count\n      FROM public.customers\n      WHERE (company_name ILIKE ${searchPattern} OR contact_person ILIKE ${searchPattern} OR phone ILIKE ${searchPattern})\n      ORDER BY company_name ASC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(customersResult[0]?.full_count || 0);\n    // Remove full_count from each item to keep response clean\n    const customers = customersResult.map(({ full_count, ...rest }) => rest);\n\n    return NextResponse.json(formatPaginatedResponse(customers, totalCount, paginationParams));\n  } catch (error) {\n    console.error(\"Failed to fetch customers:\", error);\n    return NextResponse.json(\n      { error: \"Unable to fetch customers\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/customers:\n *   post:\n *     summary: Create a new customer\n *     description: Adds a new customer to the database.\n *     tags: [Customers]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - company_name\n *             properties:\n *               company_name:\n *                 type: string\n *               contact_person:\n *                 type: string\n *               phone:\n *                 type: string\n *               address:\n *                 type: string\n *               customer_type:\n *                 type: string\n *     responses:\n *       201:\n *         description: The created customer.\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 id:\n *                   type: string\n *                   format: uuid\n *                 company_name:\n *                   type: string\n *                 contact_person:\n *                   type: string\n *                 phone:\n *                   type: string\n *                 address:\n *                   type: string\n *                 customer_type:\n *                   type: string\n *       400:\n *         description: Bad request, missing company_name.\n */\nexport async function POST(request: Request) {\n  try {\n    await requireRole([\"Admin\", \"Manager\", \"Sales\"]);\n\n    const body = await request.json();\n    const { company_name, contact_person, phone, address, customer_type } =\n      body;\n\n    if (!company_name) {\n      return NextResponse.json(\n        { error: \"company_name is required\" },\n        { status: 400 }\n      );\n    }\n\n    const newCustomer = await prisma.customers.create({\n      data: {\n        company_name,\n        contact_person,\n        phone,\n        address,\n        customer_type,\n      },\n    });\n\n    return NextResponse.json(newCustomer, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to create customer:\", error);\n    return NextResponse.json(\n      { error: \"Unable to create customer\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/departments/[id]/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/departments/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[940,943],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[940,943],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":43,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":60}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\n\n/**\n * @swagger\n * /api/departments:\n *   get:\n *     summary: Retrieve a list of departments\n *     description: Fetches a list of all departments.\n *     tags: [Departments]\n *     responses:\n *       200:\n *         description: A list of departments.\n *         content:\n *           application/json:\n *             schema:\n *               type: array\n *               items:\n *                 type: object\n *                 properties:\n *                   id:\n *                     type: string\n *                     format: uuid\n *                   name:\n *                     type: string\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: Request) {\n  try {\n    const paginationParams = getPaginationParams(req, 20);\n\n    const departmentsResult = await prisma.$queryRaw<any[]>`\n      SELECT \n        *,\n        COUNT(*) OVER() as full_count\n      FROM public.departments\n      ORDER BY name ASC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(departmentsResult[0]?.full_count || 0);\n    const departments = departmentsResult.map(({ full_count, ...rest }) => rest);\n\n    return NextResponse.json(formatPaginatedResponse(departments, totalCount, paginationParams));\n  } catch (error) {\n    console.error(\"Failed to fetch departments:\", error);\n    return NextResponse.json(\n      { error: \"Unable to fetch departments\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/departments:\n *   post:\n *     summary: Create a new department\n *     description: Adds a new department to the database.\n *     tags: [Departments]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - name\n *             properties:\n *               name:\n *                 type: string\n *     responses:\n *       201:\n *         description: The created department.\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 id:\n *                   type: string\n *                   format: uuid\n *                 name:\n *                   type: string\n *       400:\n *         description: Bad request, missing name.\n */\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const { name } =\n      body;\n\n    if (!name) {\n      return NextResponse.json(\n        { error: \"name is required\" },\n        { status: 400 }\n      );\n    }\n\n    const newDepartment = await prisma.departments.create({\n      data: {\n        name,\n      },\n    });\n\n    return NextResponse.json(newDepartment, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to create department:\", error);\n    return NextResponse.json(\n      { error: \"Unable to create department\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/inventory/route.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'whereClause' is never reassigned. Use 'const' instead.","line":43,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":43,"endColumn":25,"fix":{"range":[1199,1225],"text":"const whereClause: any = {};"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1216,1219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1216,1219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1733,1736],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1733,1736],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2832,2835],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2832,2835],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3312,3315],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3312,3315],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db } from \"@/lib/db\";\nimport { getCurrentUserWithRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/inventory:\n *   get:\n *     summary: Get inventory (materials and services)\n *     description: Sales can view inventory. Technicians cannot.\n *     tags:\n *       - Inventory\n *     responses:\n *       200:\n *         description: List of materials and services\n *       403:\n *         description: Forbidden\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: NextRequest) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // Technicians cannot view inventory\n    if (currentUser.role === \"Technician\") {\n      return NextResponse.json(\n        {\n          error: \"Forbidden: Technicians do not have access to inventory\",\n        },\n        { status: 403 }\n      );\n    }\n\n    const { searchParams } = new URL(req.url);\n    const search = searchParams.get(\"search\");\n    const paginationParams = getPaginationParams(req, 20);\n\n    let whereClause: any = {};\n\n    if (search) {\n      whereClause.OR = [\n        { model_name: { contains: search, mode: \"insensitive\" } },\n        { product_code: { contains: search, mode: \"insensitive\" } },\n      ];\n    }\n\n    const currentYear = new Date().getFullYear();\n    const currentMonth = new Date().getMonth() + 1;\n    const searchPattern = search ? `%${search}%` : \"%\";\n\n    // 1. Fetch Products with optimized Raw SQL to aggregate stock in 1 query\n    const [products, totalCount] = await Promise.all([\n      db.$queryRaw<any[]>`\n        SELECT \n          p.product_id, \n          p.product_code, \n          p.model_name, \n          p.unit,\n          COALESCE(CAST(o.opening_qty AS FLOAT), 0) as opening,\n          COALESCE(CAST(SUM(m.in_qty) AS FLOAT), 0) as total_in,\n          COALESCE(CAST(SUM(m.out_qty) AS FLOAT), 0) as total_out\n        FROM public.dim_product p\n        LEFT JOIN public.inventory_month_opening o ON p.product_id = o.product_id \n          AND o.year = ${currentYear} AND o.month = ${currentMonth}\n        LEFT JOIN public.inventory_daily_movement m ON p.product_id = m.product_id \n          AND m.year = ${currentYear} AND m.month = ${currentMonth}\n        WHERE (p.model_name ILIKE ${searchPattern} OR p.product_code ILIKE ${searchPattern})\n        GROUP BY p.product_id, p.product_code, p.model_name, p.unit, o.opening_qty\n        ORDER BY p.model_name ASC\n        LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n      `,\n      db.dim_product.count({ where: whereClause }),\n    ]);\n\n    // 2. Map Raw SQL result to expected response format\n    const inventory = products.map((p: any) => {\n      const currentStock = p.opening + p.total_in - p.total_out;\n\n      return {\n        id: p.product_code,\n        item_code: p.product_code,\n        name: p.model_name,\n        unit: p.unit,\n        quantity: currentStock,\n        details: {\n          opening: p.opening,\n          in: p.total_in,\n          out: p.total_out\n        }\n      };\n    });\n\n    return NextResponse.json(formatPaginatedResponse(inventory, totalCount, paginationParams));\n  } catch (error: any) {\n    console.error(\"Error fetching inventory:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch inventory\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/job-reports/[id]/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1781,1784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1781,1784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":106,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2633,2636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2633,2636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db } from \"@/lib/db\";\nimport { requireRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/job-reports/{id}:\n *   put:\n *     summary: Update a job report (Admin/Manager only)\n *     description: Only Admin and Manager can edit reports (Data Integrity - Method A)\n *     tags:\n *       - Job Reports\n *     parameters:\n *       - in: path\n *         name: id\n *         required: true\n *         schema:\n *           type: string\n *     responses:\n *       200:\n *         description: Report updated\n *       403:\n *         description: Forbidden\n *   delete:\n *     summary: Delete a job report (Admin only)\n *     description: Only Admin can delete reports (Data Integrity - Method A)\n *     tags:\n *       - Job Reports\n *     parameters:\n *       - in: path\n *         name: id\n *         required: true\n *         schema:\n *           type: string\n *     responses:\n *       200:\n *         description: Report deleted\n *       403:\n *         description: Forbidden\n */\n\nexport async function PUT(\n  req: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // DATA INTEGRITY (Phương án A - Mục 5): Only Admin/Manager can edit\n    await requireRole([\"Admin\", \"Manager\"]);\n\n    const { id } = await params;\n    const body = await req.json();\n\n    const updatedReport = await db.job_reports.update({\n      where: { id },\n      data: {\n        problem_summary: body.problem_summary,\n        actions_taken: body.actions_taken,\n        image_urls: body.image_urls,\n        voice_message_url: body.voice_message_url,\n        customer_ref: body.customer_ref,\n      },\n    });\n\n    return NextResponse.json({\n      success: true,\n      report: updatedReport,\n    });\n  } catch (error: any) {\n    console.error(\"Error updating report:\", error);\n\n    if (error.message.includes(\"Forbidden\")) {\n      return NextResponse.json(\n        {\n          error:\n            \"Chỉ Admin/Manager mới được phép chỉnh sửa báo cáo (Data Integrity Policy)\",\n        },\n        { status: 403 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to update report\" },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(\n  req: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // DATA INTEGRITY (Phương án A - Mục 5): Only Admin can delete\n    await requireRole([\"Admin\"]);\n\n    const { id } = await params;\n\n    await db.job_reports.delete({\n      where: { id },\n    });\n\n    return NextResponse.json({\n      success: true,\n      message: \"Report deleted successfully\",\n    });\n  } catch (error: any) {\n    console.error(\"Error deleting report:\", error);\n\n    if (error.message.includes(\"Forbidden\")) {\n      return NextResponse.json(\n        {\n          error: \"Chỉ Admin mới được phép xóa báo cáo (Data Integrity Policy)\",\n        },\n        { status: 403 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to delete report\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/job-reports/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'requireRole' is defined but never used.","line":3,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":45},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":138,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3535,3538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3535,3538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":186,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4800,4803],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4800,4803],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":207,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":207,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5635,5638],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5635,5638],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":227,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":227,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6178,6181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6178,6181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db } from \"@/lib/db\";\nimport { getCurrentUserWithRole, requireRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/job-reports:\n *   post:\n *     summary: Submit a job report\n *     description: Technician submits report with mandatory image or voice. Job status changes to \"Chờ duyệt\".\n *     tags:\n *       - Job Reports\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - job_id\n *             properties:\n *               job_id:\n *                 type: string\n *               problem_summary:\n *                 type: string\n *               actions_taken:\n *                 type: string\n *               image_urls:\n *                 type: array\n *                 items:\n *                   type: string\n *               voice_message_url:\n *                 type: string\n *               customer_ref:\n *                 type: string\n *     responses:\n *       201:\n *         description: Report submitted successfully\n *       400:\n *         description: Validation error - Image or voice required\n *       401:\n *         description: Unauthorized\n */\nexport async function POST(req: NextRequest) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const body = await req.json();\n    const {\n      job_id,\n      problem_summary,\n      actions_taken,\n      image_urls = [],\n      voice_message_url,\n      customer_ref,\n    } = body;\n\n    if (!job_id) {\n      return NextResponse.json(\n        { error: \"job_id is required\" },\n        { status: 400 }\n      );\n    }\n\n    // VALIDATION: Mandatory Image OR Voice (Phương án A - Mục 7)\n    if (image_urls.length === 0 && !voice_message_url) {\n      return NextResponse.json(\n        {\n          error:\n            \"Báo cáo phải có ít nhất 1 hình ảnh hoặc 1 đoạn voice. Vui lòng bổ sung.\",\n        },\n        { status: 400 }\n      );\n    }\n\n    // Verify job exists and user has access\n    const job = await db.jobs.findUnique({\n      where: { id: job_id },\n    });\n\n    if (!job) {\n      return NextResponse.json({ error: \"Job not found\" }, { status: 404 });\n    }\n\n    // Technicians can only report on their assigned jobs\n    if (\n      currentUser.role === \"Technician\" &&\n      job.assigned_technician_id !== currentUser.id\n    ) {\n      return NextResponse.json(\n        { error: \"Forbidden: You can only report on your assigned jobs\" },\n        { status: 403 }\n      );\n    }\n\n    // Create the report\n    const report = await db.job_reports.create({\n      data: {\n        job_id,\n        created_by_user_id: currentUser.id,\n        problem_summary,\n        actions_taken,\n        image_urls,\n        voice_message_url,\n        customer_ref,\n      },\n      include: {\n        users: {\n          select: {\n            id: true,\n            full_name: true,\n            email: true,\n          },\n        },\n      },\n    });\n\n    // QC WORKFLOW (Phương án A - Mục 4): Change job status to \"Chờ duyệt\"\n    await db.jobs.update({\n      where: { id: job_id },\n      data: {\n        status: \"Ch_duy_t\", // \"Chờ duyệt\" - Pending Approval\n      },\n    });\n\n    return NextResponse.json(\n      {\n        success: true,\n        report,\n        message: \"Báo cáo đã được gửi và đang chờ duyệt\",\n      },\n      { status: 201 }\n    );\n  } catch (error: any) {\n    console.error(\"Error creating job report:\", error);\n    return NextResponse.json(\n      { error: \"Failed to create report\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/job-reports:\n *   get:\n *     summary: Get job reports\n *     description: Returns reports based on user role and permissions\n *     tags:\n *       - Job Reports\n *     responses:\n *       200:\n *         description: List of reports\n *       401:\n *         description: Unauthorized\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: NextRequest) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const paginationParams = getPaginationParams(req);\n    const url = new URL(req.url);\n    const jobId = url.searchParams.get(\"job_id\");\n\n    // Build SQL fragments\n    let jobIdFilterSql = \"\";\n    if (jobId) {\n      jobIdFilterSql = ` AND j_rep.job_id = '${jobId}'`;\n    }\n\n    let techFilterSql = \"\";\n    if (currentUser.role === \"Technician\") {\n      techFilterSql = ` AND j_rep.created_by_user_id = '${currentUser.id}'`;\n    }\n\n    const reportsResult = await db.$queryRaw<any[]>`\n      SELECT \n        j_rep.*,\n        COUNT(*) OVER() as full_count,\n        u.full_name as creator_full_name,\n        u.email as creator_email,\n        j.job_code,\n        j.status as job_status,\n        c.company_name as customer_company_name,\n        c.contact_person as customer_contact_person\n      FROM public.job_reports j_rep\n      LEFT JOIN public.users u ON j_rep.created_by_user_id = u.id\n      LEFT JOIN public.jobs j ON j_rep.job_id = j.id\n      LEFT JOIN public.customers c ON j.customer_id = c.id\n      WHERE 1=1 ${db.$queryRawUnsafe(jobIdFilterSql)} ${db.$queryRawUnsafe(techFilterSql)}\n      ORDER BY j_rep.timestamp DESC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(reportsResult[0]?.full_count || 0);\n\n    const reports = reportsResult.map((r: any) => ({\n      ...r,\n      users: {\n        id: r.created_by_user_id,\n        full_name: r.creator_full_name,\n        email: r.creator_email,\n      },\n      jobs: {\n        id: r.job_id,\n        job_code: r.job_code,\n        status: r.job_status,\n        customers: {\n          id: r.customer_id,\n          company_name: r.customer_company_name,\n          contact_person: r.customer_contact_person,\n        },\n      },\n    }));\n\n    return NextResponse.json(formatPaginatedResponse(reports, totalCount, paginationParams));\n  } catch (error: any) {\n    console.error(\"Error fetching reports:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch reports\" },\n      { status: 500 }\n    );\n  }\n}","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/jobs/[id]/approve/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2664,2667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2664,2667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db } from \"@/lib/db\";\nimport { requireRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/jobs/{id}/approve:\n *   post:\n *     summary: Approve a job (Manager/Admin only)\n *     description: Changes job status from \"Chờ duyệt\" to \"Hoàn thành\" (QC Workflow - Method A)\n *     tags:\n *       - Jobs\n *     parameters:\n *       - in: path\n *         name: id\n *         required: true\n *         schema:\n *           type: string\n *     responses:\n *       200:\n *         description: Job approved\n *       403:\n *         description: Forbidden\n *       400:\n *         description: Job is not in pending approval status\n */\nexport async function POST(\n  req: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    // QC WORKFLOW (Phương án A - Mục 4): Only Manager/Admin can approve\n    const currentUser = await requireRole([\"Admin\", \"Manager\"]);\n\n    const { id } = await params;\n\n    const job = await db.jobs.findUnique({\n      where: { id },\n      include: {\n        users_jobs_assigned_technician_idTousers: {\n          select: {\n            department_id: true,\n          },\n        },\n      },\n    });\n\n    if (!job) {\n      return NextResponse.json({ error: \"Job not found\" }, { status: 404 });\n    }\n\n    // Manager can only approve jobs in their department\n    if (currentUser.role === \"Manager\" && currentUser.department_id) {\n      const techDeptId = job.users_jobs_assigned_technician_idTousers?.department_id;\n      if (techDeptId !== currentUser.department_id) {\n        return NextResponse.json(\n          {\n            error:\n              \"Forbidden: You can only approve jobs in your department\",\n          },\n          { status: 403 }\n        );\n      }\n    }\n\n    // Verify job is in pending approval status\n    if (job.status !== \"Ch_duy_t\") {\n      return NextResponse.json(\n        {\n          error: `Job is not in pending approval status. Current status: ${job.status}`,\n        },\n        { status: 400 }\n      );\n    }\n\n    // Approve: Change status to \"Hoàn thành\"\n    const updatedJob = await db.jobs.update({\n      where: { id },\n      data: {\n        status: \"Ho_n_th_nh\", // \"Hoàn thành\" - Completed\n        actual_end_time: new Date(),\n      },\n      include: {\n        customers: true,\n        users_jobs_assigned_technician_idTousers: {\n          select: {\n            id: true,\n            full_name: true,\n            email: true,\n          },\n        },\n      },\n    });\n\n    return NextResponse.json({\n      success: true,\n      job: updatedJob,\n      message: \"Công việc đã được duyệt và hoàn thành\",\n    });\n  } catch (error: any) {\n    console.error(\"Error approving job:\", error);\n\n    if (error.message.includes(\"Forbidden\") || error.message.includes(\"Unauthorized\")) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: error.message.includes(\"Unauthorized\") ? 401 : 403 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to approve job\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/jobs/[id]/route.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":193,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5062,5065],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5062,5065],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/jobs/assign/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getCurrentUserWithRole' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2322,2325],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2322,2325],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db } from \"@/lib/db\";\nimport { getCurrentUserWithRole, canAssignToTechnician, requireRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/jobs/assign:\n *   post:\n *     summary: Assign a job to a technician\n *     description: Admin can assign to any technician. Manager can only assign to technicians in their department.\n *     tags:\n *       - Jobs\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - jobId\n *               - technicianId\n *             properties:\n *               jobId:\n *                 type: string\n *               technicianId:\n *                 type: string\n *     responses:\n *       200:\n *         description: Job assigned successfully\n *       403:\n *         description: Forbidden - Cannot assign to technician outside your department\n *       401:\n *         description: Unauthorized\n */\nexport async function POST(req: NextRequest) {\n  try {\n    // Require Admin or Manager role\n    const currentUser = await requireRole([\"Admin\", \"Manager\"]);\n\n    const body = await req.json();\n    const { jobId, technicianId } = body;\n\n    if (!jobId || !technicianId) {\n      return NextResponse.json(\n        { error: \"jobId and technicianId are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Check if user can assign to this technician\n    const canAssign = await canAssignToTechnician(currentUser, technicianId);\n\n    if (!canAssign) {\n      return NextResponse.json(\n        {\n          error:\n            \"Forbidden: You can only assign jobs to technicians in your department\",\n        },\n        { status: 403 }\n      );\n    }\n\n    // Update the job\n    const updatedJob = await db.jobs.update({\n      where: { id: jobId },\n      data: {\n        assigned_technician_id: technicianId,\n        status: \"ph_n_c_ng\", // \"Đã phân công\"\n      },\n      include: {\n        users_jobs_assigned_technician_idTousers: {\n          select: {\n            id: true,\n            full_name: true,\n            email: true,\n          },\n        },\n        customers: true,\n      },\n    });\n\n    return NextResponse.json({\n      success: true,\n      job: updatedJob,\n    });\n  } catch (error: any) {\n    console.error(\"Error assigning job:\", error);\n\n    if (error.message.includes(\"Unauthorized\") || error.message.includes(\"Forbidden\")) {\n      return NextResponse.json(\n        { error: error.message },\n        { status: error.message.includes(\"Unauthorized\") ? 401 : 403 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to assign job\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/jobs/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dateFilterSql' is assigned a value but never used.","line":236,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":236,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":253,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":253,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7481,7484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7481,7484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'jobs' is never reassigned. Use 'const' instead.","line":306,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":306,"endColumn":13,"fix":{"range":[9420,10406],"text":"const jobs = jobsResult.map((j: any) => {\n      const mappedJob = {\n        ...j,\n        customers: {\n          id: j.customer_id,\n          company_name: j.customer_company_name,\n          contact_person: j.customer_contact_person,\n          phone: j.customer_phone,\n          address: j.customer_address,\n        },\n        users_jobs_assigned_technician_idTousers: j.tech_full_name ? {\n          id: j.assigned_technician_id,\n          full_name: j.tech_full_name,\n          email: j.tech_email,\n        } : null,\n        job_line_items: j.line_items || [],\n        job_technicians: j.technicians || [],\n      };\n\n      // Sales restriction\n      if (currentUser.role === \"Sales\") {\n        mappedJob.customers = {\n          id: j.customer_id,\n          company_name: j.customer_company_name,\n        };\n      }\n\n      // Technician restriction\n      if (currentUser.role === \"Technician\") {\n        return sanitizeJobForTechnician(mappedJob);\n      }\n\n      return mappedJob;\n    });"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":306,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":306,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9450,9453],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9450,9453],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { job_type_enum } from \"@prisma/client\";\nimport { db } from \"@/lib/db\";\nimport { getCurrentUserWithRole, sanitizeJobForTechnician, canAssignToTechnician } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/jobs:\n *   post:\n *     summary: Create a new job\n *     description: Admin and Manager can create new jobs. Job is created with status \"Mới\" (New).\n *     tags:\n *       - Jobs\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - job_code\n *               - customer_id\n *               - job_type\n *             properties:\n *               job_code:\n *                 type: string\n *               customer_id:\n *                 type: string\n *               job_type:\n *                 type: string\n *                 enum: [\"Lắp đặt mới\", \"Bảo hành\", \"Sửa chữa\"]\n *               scheduled_start_time:\n *                 type: string\n *                 format: date-time\n *               scheduled_end_time:\n *                 type: string\n *                 format: date-time\n *               notes:\n *                 type: string\n *     responses:\n *       201:\n *         description: Job created successfully\n *       400:\n *         description: Bad request - Missing required fields\n *       401:\n *         description: Unauthorized\n *       403:\n *         description: Forbidden - Only Admin and Manager can create jobs\n */\nexport async function POST(req: NextRequest) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // RBAC: Only Admin and Manager can create jobs\n    if (![\"Admin\", \"Manager\"].includes(currentUser.role)) {\n      return NextResponse.json(\n        { error: \"Forbidden: Only Admin and Manager can create jobs\" },\n        { status: 403 }\n      );\n    }\n\n    const body = await req.json();\n    console.log(\"POST /api/jobs payload:\", body);\n\n    const {\n      job_code,\n      customer_id,\n      job_type,\n      scheduled_start_time,\n      scheduled_end_time,\n      notes,\n      assigned_technician_id, // Legacy single technician (deprecated)\n      assigned_technician_ids, // New: array of technician IDs\n    } = body;\n\n    // Validate required fields\n    if (!job_code || !customer_id || !job_type) {\n      console.log(\"Missing required fields:\", { job_code, customer_id, job_type });\n      return NextResponse.json(\n        { error: \"job_code, customer_id, and job_type are required\" },\n        { status: 400 }\n      );\n    }\n\n    // Validate job_type enum\n    const validJobTypes = [\"Lắp đặt mới\", \"Bảo hành\", \"Sửa chữa\"];\n    if (!validJobTypes.includes(job_type)) {\n      console.log(\"Invalid job_type:\", job_type);\n      return NextResponse.json(\n        {\n          error: `Invalid job_type. Must be one of: ${validJobTypes.join(\", \")}`,\n        },\n        { status: 400 }\n      );\n    }\n\n    // Validate technician assignments if provided\n    const technicianIds = assigned_technician_ids || (assigned_technician_id ? [assigned_technician_id] : []);\n\n    if (technicianIds.length > 0) {\n      for (const techId of technicianIds) {\n        const canAssign = await canAssignToTechnician(currentUser, techId);\n        if (!canAssign) {\n          return NextResponse.json(\n            { error: `Forbidden: You cannot assign jobs to technician ${techId}` },\n            { status: 403 }\n          );\n        }\n      }\n    }\n\n    // Map display string to Prisma Enum Key\n    const jobTypeMap: Record<string, string> = {\n      \"Lắp đặt mới\": \"L_p___t_m_i\",\n      \"Bảo hành\": \"B_o_h_nh\",\n      \"Sửa chữa\": \"S_a_ch_a\",\n    };\n\n    // Check if customer exists\n    const customer = await db.customers.findUnique({\n      where: { id: customer_id },\n    });\n\n    if (!customer) {\n      return NextResponse.json(\n        { error: \"Customer not found\" },\n        { status: 404 }\n      );\n    }\n\n    // Create the job\n    const newJob = await db.jobs.create({\n      data: {\n        job_code,\n        customer_id,\n        job_type: jobTypeMap[job_type] as job_type_enum, // Map to Prisma Enum\n        scheduled_start_time: scheduled_start_time\n          ? new Date(scheduled_start_time)\n          : null,\n        scheduled_end_time: scheduled_end_time\n          ? new Date(scheduled_end_time)\n          : null,\n        notes,\n        created_by_user_id: currentUser.id,\n        status: \"ph_n_c_ng\",\n        assigned_technician_id: technicianIds[0] || null, // Keep first technician for backward compatibility\n      },\n      include: {\n        customers: true,\n        users_jobs_created_by_user_idTousers: {\n          select: {\n            id: true,\n            full_name: true,\n            email: true,\n          },\n        },\n      },\n    });\n\n    // Create job_technicians entries for all assigned technicians\n    if (technicianIds.length > 0) {\n      await db.job_technicians.createMany({\n        data: technicianIds.map((techId: string) => ({\n          job_id: newJob.id,\n          technician_id: techId,\n        })),\n        skipDuplicates: true,\n      });\n    }\n\n    return NextResponse.json(\n      {\n        success: true,\n        job: newJob,\n        message: \"Job created successfully\",\n      },\n      { status: 201 }\n    );\n  } catch (error: unknown) {\n    console.error(\"Error creating job:\", error);\n\n    const prismaError = error as { code?: string };\n    if (prismaError.code === \"P2002\") {\n      return NextResponse.json(\n        { error: \"Job code already exists\" },\n        { status: 409 }\n      );\n    }\n\n    return NextResponse.json(\n      { error: \"Failed to create job\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/jobs:\n *   get:\n *     summary: Get jobs list\n *     description: Returns jobs based on user role. Technicians only see their assigned jobs with financial data hidden.\n *     tags:\n *       - Jobs\n *     responses:\n *       200:\n *         description: List of jobs\n *       401:\n *         description: Unauthorized\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: NextRequest) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const paginationParams = getPaginationParams(req);\n    const url = new URL(req.url);\n    const startDate = url.searchParams.get(\"startDate\");\n    const endDate = url.searchParams.get(\"endDate\");\n\n    // Build SQL date filter fragments\n    let dateFilterSql = \"\";\n    if (startDate) {\n      dateFilterSql += ` AND scheduled_start_time >= ${startDate}`;\n    }\n    if (endDate) {\n      dateFilterSql += ` AND scheduled_start_time <= ${endDate}`;\n    }\n\n    // Role-based filter\n    let roleFilterSql = \"\";\n    if (currentUser.role === \"Technician\") {\n      roleFilterSql = ` AND assigned_technician_id = '${currentUser.id}'`;\n    } else if (currentUser.role === \"Manager\" && currentUser.department_id) {\n      // Manager sees jobs assigned to technicians in their department\n      roleFilterSql = ` AND EXISTS (\n        SELECT 1 FROM public.users u \n        WHERE u.id = jobs.assigned_technician_id \n        AND u.department_id = '${currentUser.department_id}'\n      )`;\n    }\n\n    // Main Query using Raw SQL\n    const jobsResult = await db.$queryRaw<any[]>`\n      WITH filtered_jobs AS (\n        SELECT \n          j.*,\n          COUNT(*) OVER() as full_count\n        FROM public.jobs j\n        WHERE 1=1 ${roleFilterSql ? db.$queryRawUnsafe(roleFilterSql) : \"\"}\n        ${startDate ? db.$queryRawUnsafe(` AND j.scheduled_start_time >= '${startDate}'`) : \"\"}\n        ${endDate ? db.$queryRawUnsafe(` AND j.scheduled_start_time <= '${endDate}'`) : \"\"}\n        ORDER BY j.scheduled_start_time DESC\n        LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n      )\n      SELECT \n        j.*,\n        c.company_name as customer_company_name,\n        c.contact_person as customer_contact_person,\n        c.phone as customer_phone,\n        c.address as customer_address,\n        u_tech.full_name as tech_full_name,\n        u_tech.email as tech_email,\n        (\n          SELECT jsonb_agg(jsonb_build_object(\n            'id', li.id,\n            'quantity', li.quantity,\n            'materials_and_services', jsonb_build_object(\n              'id', ms.id,\n              'name', ms.name,\n              'unit', ms.unit\n            )\n          ))\n          FROM public.job_line_items li\n          JOIN public.materials_and_services ms ON li.material_service_id = ms.id\n          WHERE li.job_id = j.id\n        ) as line_items,\n        (\n          SELECT jsonb_agg(jsonb_build_object(\n            'users', jsonb_build_object(\n              'id', u.id,\n              'full_name', u.full_name\n            )\n          ))\n          FROM public.job_technicians jt\n          JOIN public.users u ON jt.technician_id = u.id\n          WHERE jt.job_id = j.id\n        ) as technicians\n      FROM filtered_jobs j\n      LEFT JOIN public.customers c ON j.customer_id = c.id\n      LEFT JOIN public.users u_tech ON j.assigned_technician_id = u_tech.id\n    `;\n\n    const totalCount = Number(jobsResult[0]?.full_count || 0);\n\n    // Map Raw SQL result to expected response format (sanitize if needed)\n    let jobs = jobsResult.map((j: any) => {\n      const mappedJob = {\n        ...j,\n        customers: {\n          id: j.customer_id,\n          company_name: j.customer_company_name,\n          contact_person: j.customer_contact_person,\n          phone: j.customer_phone,\n          address: j.customer_address,\n        },\n        users_jobs_assigned_technician_idTousers: j.tech_full_name ? {\n          id: j.assigned_technician_id,\n          full_name: j.tech_full_name,\n          email: j.tech_email,\n        } : null,\n        job_line_items: j.line_items || [],\n        job_technicians: j.technicians || [],\n      };\n\n      // Sales restriction\n      if (currentUser.role === \"Sales\") {\n        mappedJob.customers = {\n          id: j.customer_id,\n          company_name: j.customer_company_name,\n        };\n      }\n\n      // Technician restriction\n      if (currentUser.role === \"Technician\") {\n        return sanitizeJobForTechnician(mappedJob);\n      }\n\n      return mappedJob;\n    });\n\n    return NextResponse.json(formatPaginatedResponse(jobs, totalCount, paginationParams));\n  } catch (error: unknown) {\n    console.error(\"Error fetching jobs:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch jobs\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/knowledge/sources/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1050,1053],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1050,1053],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":50,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":50,"endColumn":52}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\n\n/**\n * @swagger\n * /api/knowledge/sources:\n *   get:\n *     summary: List knowledge sources\n *     tags: [Knowledge Base]\n *     responses:\n *       200:\n *         description: List of sources\n *   post:\n *     summary: Add a knowledge source\n *     tags: [Knowledge Base]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - drive_name\n *               - drive_file_id\n *             properties:\n *               drive_name:\n *                 type: string\n *               drive_file_id:\n *                 type: string\n *     responses:\n *       201:\n *         description: Source added\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: Request) {\n  try {\n    const paginationParams = getPaginationParams(req);\n\n    const sourcesResult = await prisma.$queryRaw<any[]>`\n      SELECT \n        *,\n        COUNT(*) OVER() as full_count\n      FROM public.knowledge_sources\n      ORDER BY created_at DESC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(sourcesResult[0]?.full_count || 0);\n    const sources = sourcesResult.map(({ full_count, ...rest }) => rest);\n\n    return NextResponse.json(formatPaginatedResponse(sources, totalCount, paginationParams));\n  } catch (error) {\n    console.error(\"Failed to fetch sources:\", error);\n    return NextResponse.json({ error: \"Failed to fetch sources\" }, { status: 500 });\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n\n    let data: {\n      drive_file_id: string;\n      drive_name: string;\n      sheet_name?: string;\n      hash?: string;\n    };\n\n    // Nếu là Web URL (từ chức năng \"Thêm nguồn\")\n    if (body.source_url) {\n      const url = body.source_url;\n      let pageTitle = body.source_name || url; // Mặc định là user input hoặc URL\n\n      try {\n        // Fetch URL để lấy metadata (title)\n        const res = await fetch(url, {\n          headers: { 'User-Agent': 'Mozilla/5.0 (compatible; KnowledgeBot/1.0)' }\n        });\n        if (res.ok) {\n          const html = await res.text();\n          // Regex đơn giản để lấy nội dung thẻ <title>\n          const match = html.match(/<title[^>]*>([^<]+)<\\/title>/i);\n          if (match && match[1]) {\n            pageTitle = match[1].trim();\n          }\n        }\n      } catch (err) {\n        console.error(\"Error fetching URL metadata:\", err);\n        // Nếu lỗi fetch thì vẫn giữ title mặc định và tiếp tục lưu\n      }\n\n      data = {\n        drive_file_id: url,          // Lưu URL vào drive_file_id\n        drive_name: pageTitle,       // Lưu Title lấy được vào drive_name\n        sheet_name: \"WEB_URL\",       // Đánh dấu loại (tận dụng trường sheet_name)\n        hash: body.refresh_frequency // Tận dụng trường hash để lưu frequency\n      };\n    } else {\n      // Logic cũ cho Google Drive/Sheet\n      data = {\n        drive_file_id: body.drive_file_id,\n        drive_name: body.drive_name,\n        hash: body.hash,\n        sheet_name: body.sheet_name,\n      };\n    }\n\n    const newSource = await prisma.knowledge_sources.create({\n      data: data\n    });\n\n    return NextResponse.json(newSource, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to add source:\", error);\n    return NextResponse.json({ error: \"Failed to add source\" }, { status: 500 });\n  }\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/knowledge/upload/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":25,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":157,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":157,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4592,4595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4592,4595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\nimport { google } from 'googleapis';\nimport { Readable } from 'stream';\nimport { db as prisma } from \"@/lib/db\";\n\n\nasync function uploadToGoogleDrive(file: File) {\n  const serviceAccountBase64 = process.env.GOOGLE_SERVICE_ACCOUNT_BASE64;\n  const folderId = process.env.GOOGLE_DRIVE_FOLDER_ID;\n  const userToImpersonate = process.env.GOOGLE_DRIVE_IMPERSONATED_USER_EMAIL;\n\n  if (!serviceAccountBase64 || !folderId || !userToImpersonate) {\n    throw new Error(\"Missing Google Drive configuration (Env vars)\");\n  }\n\n  // 1. Decode a key\n  const serviceAccountJson = Buffer.from(\n    serviceAccountBase64,\n    'base64'\n  ).toString('utf-8');\n\n  let credentials;\n  try {\n    credentials = JSON.parse(serviceAccountJson);\n  } catch (e) {\n    throw new Error(\"Invalid Google Service Account JSON\");\n  }\n\n  // 2. Auth\n  const auth = new google.auth.JWT({\n    email: credentials.client_email,\n    key: credentials.private_key,\n    scopes: ['https://www.googleapis.com/auth/drive.file'],\n    subject: userToImpersonate,\n  });\n\n  const drive = google.drive({ version: 'v3', auth });\n\n  // 3. Prepare content\n  const fileBuffer = Buffer.from(await file.arrayBuffer());\n  const media = {\n    mimeType: file.type,\n    body: Readable.from(fileBuffer),\n  };\n\n  // 4. Send file\n  const response = await drive.files.create({\n    media: media,\n    requestBody: {\n      name: file.name,\n      parents: [folderId],\n    },\n    fields: 'id,name',\n  });\n\n  return response.data;\n}\n\n\n/**\n * @swagger\n * /api/knowledge/upload:\n *   post:\n *     summary: Upload a file to Google Drive for n8n processing\n *     description: Receives a file and uploads it to a pre-configured Google Drive folder, triggering the n8n knowledge ingestion workflow.\n *     tags: [Knowledge]\n *     requestBody:\n *       required: true\n *       content:\n *         multipart/form-data:\n *           schema:\n *             type: object\n *             properties:\n *               file:\n *                 type: string\n *                 format: binary\n *                 description: The file to be processed.\n *     responses:\n *       200:\n *         description: File uploaded successfully to Google Drive.\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 message:\n *                   type: string\n *                   example: \"File uploaded successfully to Google Drive\"\n *                 fileId:\n *                   type: string\n *       400:\n *         description: Bad request, file is required.\n *       500:\n *         description: Internal server error, e.g., failed to upload.\n */\nexport async function POST(request: Request) {\n  try {\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n\n    if (!file) {\n      return NextResponse.json({ error: 'File is required' }, { status: 400 });\n    }\n\n    // Step 1: Upload the file to Google Drive\n    const uploadedFile = await uploadToGoogleDrive(file);\n\n    if (!uploadedFile.id) {\n      throw new Error(\"Failed to get file ID from Google Drive\");\n    }\n\n    // Step 2: Save metadata to Database\n    // Storing size in 'hash' as a workaround per plan\n    const sizeString = (file.size).toString();\n    // Determine sheet_name based on extension for filtering later\n    const ext = file.name.split('.').pop()?.toUpperCase() || \"FILE\";\n\n    await prisma.knowledge_sources.create({\n      data: {\n        drive_file_id: uploadedFile.id,\n        drive_name: uploadedFile.name,\n        sheet_name: ext,\n        hash: sizeString,\n      }\n    });\n\n    // Step 3: Trigger the n8n vectorization workflow\n    const n8nWebhookUrl = process.env.N8N_INGESTION_WEBHOOK_URL;\n    if (!n8nWebhookUrl) {\n      console.warn('N8N_INGESTION_WEBHOOK_URL is not defined. Skipping direct n8n trigger.');\n    } else {\n      try {\n        // Fire and forget\n        fetch(n8nWebhookUrl, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: JSON.stringify({\n            id: uploadedFile.id,\n            name: uploadedFile.name,\n            mimeType: file.type,\n          }),\n        });\n      } catch (n8nError) {\n        console.error('Failed to trigger n8n ingestion webhook:', n8nError);\n      }\n    }\n\n    // Respond to the client immediately\n    return NextResponse.json({\n      message: 'File uploaded successfully. Processing has been initiated.',\n      fileId: uploadedFile.id,\n      fileName: uploadedFile.name,\n    });\n\n  } catch (error: any) {\n    console.error('An error occurred during file upload:', error);\n    // Return the actual error message for debugging\n    return NextResponse.json({ error: error.message || 'Internal server error' }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/test-auth/route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[435,438],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[435,438],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getCurrentUserWithRole } from \"@/lib/auth-utils\";\nimport { NextResponse } from \"next/server\";\n\nexport async function GET() {\n  try {\n    const user = await getCurrentUserWithRole();\n\n    if (!user) {\n      return NextResponse.json(\n        { error: \"User not authenticated or not found\" },\n        { status: 401 }\n      );\n    }\n\n    return NextResponse.json({\n      success: true,\n      user: user,\n    });\n  } catch (error: any) {\n    console.error(\"Error in test-auth:\", error);\n    return NextResponse.json(\n      { error: error.message || \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/upload/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":57,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":57,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { writeFile, mkdir } from \"fs/promises\";\nimport path from \"path\";\n\n/**\n * @swagger\n * /api/upload:\n *   post:\n *     summary: Upload a file\n *     description: Uploads a file to the server public/uploads directory\n *     tags: [Upload]\n *     requestBody:\n *       content:\n *         multipart/form-data:\n *           schema:\n *             type: object\n *             properties:\n *               file:\n *                 type: string\n *                 format: binary\n *     responses:\n *       200:\n *         description: File uploaded successfully\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 url:\n *                   type: string\n *       400:\n *         description: No file uploaded\n *       500:\n *         description: Upload failed\n */\nexport async function POST(req: NextRequest) {\n    try {\n        const data = await req.formData();\n        const file: File | null = data.get(\"file\") as unknown as File;\n\n        if (!file) {\n            return NextResponse.json({ error: \"No file uploaded\" }, { status: 400 });\n        }\n\n        const bytes = await file.arrayBuffer();\n        const buffer = Buffer.from(bytes);\n\n        // Create unique filename\n        const timestamp = Date.now();\n        const originalName = file.name.replace(/[^a-zA-Z0-9.-]/g, \"_\"); // Sanitize\n        const filename = `${timestamp}-${originalName}`;\n\n        // Ensure upload directory exists\n        const uploadDir = path.join(process.cwd(), \"public/uploads\");\n        try {\n            await mkdir(uploadDir, { recursive: true });\n        } catch (e) {\n            // Ignore if exists\n        }\n\n        const filepath = path.join(uploadDir, filename);\n        await writeFile(filepath, buffer);\n\n        // Return public URL\n        const url = `/uploads/${filename}`;\n\n        return NextResponse.json({ url });\n    } catch (error) {\n        console.error(\"Upload error:\", error);\n        return NextResponse.json({ error: \"Upload failed\" }, { status: 500 });\n    }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/users/[id]/route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/users/route.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'whereClause' is never reassigned. Use 'const' instead.","line":58,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":58,"endColumn":25,"fix":{"range":[1756,1782],"text":"const whereClause: any = {};"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1773,1776],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1773,1776],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":89,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2858,2861],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2858,2861],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'full_count' is defined but never used.","line":105,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":105,"endColumn":48}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { db as prisma } from \"@/lib/db\";\nimport { getCurrentUserWithRole } from \"@/lib/auth-utils\";\n\n/**\n * @swagger\n * /api/users:\n *   get:\n *     summary: Retrieve a list of users\n *     description: Fetches a list of all users.\n *     tags: [Users]\n *     responses:\n *       200:\n *         description: A list of users.\n *         content:\n *           application/json:\n *             schema:\n *               type: array\n *               items:\n *                 type: object\n *                 properties:\n *                   id:\n *                     type: string\n *                   full_name:\n *                     type: string\n *                   email:\n *                     type: string\n *                   role:\n *                     type: string\n *                   department:\n *                     type: object\n *                     properties:\n *                       id:\n *                         type: string\n *                         format: uuid\n *                       name:\n *                         type: string\n */\nimport { getPaginationParams, formatPaginatedResponse } from \"@/lib/pagination\";\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const roleFilter = searchParams.get('role');\n    const search = searchParams.get('search');\n\n    const currentUser = await getCurrentUserWithRole();\n\n    if (!currentUser) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    // RBAC: Only Admin and Manager can list users\n    if (![\"Admin\", \"Manager\"].includes(currentUser.role)) {\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 });\n    }\n\n    let whereClause: any = {};\n\n    // Search filter\n    if (search) {\n      whereClause.OR = [\n        { full_name: { contains: search, mode: 'insensitive' } },\n        { email: { contains: search, mode: 'insensitive' } },\n      ];\n    }\n\n    // Filter by requested role (e.g., ?role=Technician)\n    if (roleFilter) {\n      whereClause.role = roleFilter;\n    }\n\n    let departmentFilterId: string | null = null;\n    // Manager Scope: Restrict to their own department\n    if (currentUser.role === \"Manager\") {\n      if (!currentUser.department_id) {\n        return NextResponse.json({ users: [] });\n      }\n      departmentFilterId = currentUser.department_id;\n    }\n\n    const paginationParams = getPaginationParams(req);\n    const currentSearch = searchParams.get(\"search\");\n    const currentRole = roleFilter; // Use roleFilter from initial parsing\n    const currentDepartmentId = departmentFilterId || searchParams.get(\"departmentId\"); // Use manager's department or explicit filter\n\n    const searchPattern = currentSearch ? `%${currentSearch}%` : \"%\";\n\n    const usersResult = await prisma.$queryRaw<any[]>`\n      SELECT\n        u.*,\n        COUNT(*) OVER() as full_count,\n        d.name as department_name\n      FROM public.users u\n      LEFT JOIN public.departments d ON u.department_id = d.id\n      WHERE (u.full_name ILIKE ${searchPattern} OR u.email ILIKE ${searchPattern})\n      ${currentRole ? prisma.$queryRawUnsafe(` AND u.role = '${currentRole}'`) : \"\"}\n      ${currentDepartmentId ? prisma.$queryRawUnsafe(` AND u.department_id = '${currentDepartmentId}'`) : \"\"}\n      ORDER BY u.full_name ASC\n      LIMIT ${paginationParams.limit} OFFSET ${paginationParams.skip}\n    `;\n\n    const totalCount = Number(usersResult[0]?.full_count || 0);\n\n    const users = usersResult.map(({ full_count, department_name, ...rest }) => ({\n      ...rest,\n      departments: rest.department_id ? {\n        id: rest.department_id,\n        name: department_name,\n      } : null,\n    }));\n\n    return NextResponse.json(formatPaginatedResponse(users, totalCount, paginationParams));\n  } catch (error) {\n    console.error(\"Failed to fetch users:\", error);\n    return NextResponse.json(\n      { error: \"Unable to fetch users\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/users:\n *   post:\n *     summary: Create a new user\n *     description: Adds a new user to the database.\n *     tags: [Users]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - id\n *               - full_name\n *             properties:\n *               id:\n *                 type: string\n *               full_name:\n *                 type: string\n *               email: string\n *               role: string\n *               department_id: string\n *     responses:\n *       201:\n *         description: The created user.\n *         content:\n *           application/json:\n *             schema:\n *               type: object\n *               properties:\n *                 id:\n *                   type: string\n *                 full_name:\n *                   type: string\n *                 email:\n *                   type: string\n *                   format: email\n *                 role:\n *                   type: string\n *                 department_id:\n *                   type: string\n *                   format: uuid\n *       400:\n *         description: Bad request, missing full_name.\n */\nexport async function POST(request: Request) {\n  try {\n    // For POST /api/users, typically only Admin can create users directly here\n    // But check requirements: User Management says \"Only Admin can view/create users\"\n    const currentUser = await getCurrentUserWithRole();\n    if (!currentUser || currentUser.role !== 'Admin') {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n    }\n\n    const body = await request.json();\n    const { id, full_name, email, role, department_id } =\n      body;\n\n    if (!full_name) {\n      return NextResponse.json(\n        { error: \"full_name is required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!id) {\n      return NextResponse.json(\n        { error: \"id is required\" },\n        { status: 400 }\n      );\n    }\n\n    const newUser = await prisma.users.create({\n      data: {\n        id,\n        full_name,\n        email,\n        role,\n        department_id,\n      },\n    });\n\n    return NextResponse.json(newUser, { status: 201 });\n  } catch (error) {\n    console.error(\"Failed to create user:\", error);\n    return NextResponse.json(\n      { error: \"Unable to create user\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/users:\n *   put:\n *     summary: Update a user's role or department\n *     description: Only Admin can update user details.\n *     tags: [Users]\n *     requestBody:\n *       required: true\n *       content:\n *         application/json:\n *           schema:\n *             type: object\n *             required:\n *               - id\n *             properties:\n *               id:\n *                 type: string\n *               role:\n *                 type: string\n *               department_id:\n *                 type: string\n *     responses:\n *       200:\n *         description: User updated successfully.\n *       403:\n *         description: Forbidden.\n *       404:\n *         description: User not found.\n */\nexport async function PUT(request: Request) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n    if (!currentUser || currentUser.role !== 'Admin') {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n    }\n\n    const body = await request.json();\n    const { id, role, department_id } = body;\n\n    if (!id) {\n      return NextResponse.json({ error: \"User ID is required\" }, { status: 400 });\n    }\n\n    // Optional: Validate role enum if needed\n    // Optional: Validate department existence if needed\n\n    const updatedUser = await prisma.users.update({\n      where: { id },\n      data: {\n        role,\n        department_id,\n      },\n    });\n\n    return NextResponse.json(updatedUser);\n  } catch (error) {\n    console.error(\"Failed to update user:\", error);\n    return NextResponse.json(\n      { error: \"Unable to update user\" },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * @swagger\n * /api/users:\n *   delete:\n *     summary: Delete a user\n *     description: Only Admin can delete users.\n *     tags: [Users]\n *     parameters:\n *       - in: query\n *         name: id\n *         required: true\n *         schema:\n *           type: string\n *     responses:\n *       200:\n *         description: User deleted successfully.\n *       403:\n *         description: Forbidden.\n */\nexport async function DELETE(request: Request) {\n  try {\n    const currentUser = await getCurrentUserWithRole();\n    if (!currentUser || currentUser.role !== 'Admin') {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n    }\n\n    const { searchParams } = new URL(request.url);\n    const id = searchParams.get('id');\n\n    if (!id) {\n      return NextResponse.json({ error: \"User ID is required\" }, { status: 400 });\n    }\n\n    await prisma.users.delete({\n      where: { id },\n    });\n\n    return NextResponse.json({ success: true, message: \"User deleted\" });\n  } catch (error) {\n    console.error(\"Failed to delete user:\", error);\n    return NextResponse.json(\n      { error: \"Unable to delete user\" },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/api/webhooks/clerk/route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'image_url' is assigned a value but never used.","line":47,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":47,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1902,1905],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1902,1905],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":81,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2705,2708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2705,2708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Webhook } from 'svix'\nimport { headers } from 'next/headers'\nimport { WebhookEvent } from '@clerk/nextjs/server'\nimport { prisma } from '@/lib/prisma'\n\nexport async function POST(req: Request) {\n  const WEBHOOK_SECRET = process.env.CLERK_WEBHOOK_SECRET\n\n  if (!WEBHOOK_SECRET) {\n    throw new Error('Please add CLERK_WEBHOOK_SECRET from Clerk Dashboard to .env or .env.local')\n  }\n\n  const headerPayload = await headers();\n  const svix_id = headerPayload.get(\"svix-id\");\n  const svix_timestamp = headerPayload.get(\"svix-timestamp\");\n  const svix_signature = headerPayload.get(\"svix-signature\");\n\n  if (!svix_id || !svix_timestamp || !svix_signature) {\n    return new Response('Error occured -- no svix headers', {\n      status: 400\n    })\n  }\n\n  const payload = await req.json()\n  const body = JSON.stringify(payload)\n\n  const wh = new Webhook(WEBHOOK_SECRET)\n\n  let evt: WebhookEvent\n\n  try {\n    evt = wh.verify(body, {\n      \"svix-id\": svix_id,\n      \"svix-timestamp\": svix_timestamp,\n      \"svix-signature\": svix_signature,\n    }) as WebhookEvent\n  } catch (err) {\n    console.error('Error verifying webhook:', err);\n    return new Response('Error occured', {\n      status: 400\n    })\n  }\n\n  const eventType = evt.type;\n\n  if (eventType === 'user.created') {\n    const { id, email_addresses, image_url, first_name, last_name, public_metadata } = evt.data;\n\n    const email = email_addresses[0]?.email_address;\n    const fullName = `${first_name || ''} ${last_name || ''}`.trim();\n\n    // Read role and department from Clerk metadata (set by Admin)\n    const role = (public_metadata?.role as string) || 'NOT_ASSIGN'; // Default to NOT_ASSIGN if not set\n    const departmentId = public_metadata?.department_id as string | undefined;\n\n    try {\n      await prisma.users.create({\n        data: {\n          id: id,\n          email: email,\n          full_name: fullName,\n          role: role as any, // Cast to user_role_enum\n          department_id: departmentId || null,\n        }\n      })\n      console.log(`✅ User ${id} created in DB with role: ${role}`);\n    } catch (e) {\n      console.error('❌ Error creating user in DB:', e);\n      return new Response('Error creating user in DB', { status: 500 });\n    }\n  } else if (eventType === 'user.updated') {\n    const { id, email_addresses, first_name, last_name, public_metadata } = evt.data;\n    const email = email_addresses[0]?.email_address;\n    const fullName = `${first_name || ''} ${last_name || ''}`.trim();\n\n    // Read updated role and department from metadata\n    const role = public_metadata?.role as string | undefined;\n    const departmentId = public_metadata?.department_id as string | undefined;\n\n    try {\n      const updateData: any = {\n        email: email,\n        full_name: fullName,\n      };\n\n      // Only update role/department if they exist in metadata\n      if (role) {\n        updateData.role = role;\n      }\n      if (departmentId !== undefined) {\n        updateData.department_id = departmentId || null;\n      }\n\n      await prisma.users.update({\n        where: { id: id },\n        data: updateData\n      })\n      console.log(`✅ User ${id} updated in DB`);\n    } catch (e) {\n      console.error(`❌ Error updating user ${id}:`, e);\n    }\n  }\n\n  return new Response('', { status: 200 })\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/docs/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SignInButton' is defined but never used.","line":3,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SignedIn' is defined but never used.","line":3,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SignedOut' is defined but never used.","line":3,"column":49,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserButton' is defined but never used.","line":3,"column":60,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":70}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport { ClerkProvider, SignInButton, SignedIn, SignedOut, UserButton } from '@clerk/nextjs'\nimport \"./globals.css\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"Create Next App\",\n  description: \"Generated by create next app\",\n};\n\nexport default function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  return (\n    <ClerkProvider>\n      <html lang=\"en\">\n        <body\n          className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n        >\n\n          {children}\n        </body>\n      </html>\n    </ClerkProvider>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/sign-in/[[...sign-in]]/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/app/sign-up/[[...sign-up]]/page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/check_db.ts","messages":[{"ruleId":"@typescript-eslint/no-require-imports","severity":2,"message":"A `require()` style import is forbidden.","line":2,"column":26,"nodeType":"CallExpression","messageId":"noRequireImports","endLine":2,"endColumn":51}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nconst { PrismaClient } = require('@prisma/client');\nconst prisma = new PrismaClient();\n\nasync function main() {\n  console.log('Attempting to connect to the database...');\n  try {\n    const userCount = await prisma.users.count();\n    console.log(`Successfully connected! Found ${userCount} users.`);\n    const firstUser = await prisma.users.findFirst();\n    console.log('First user:', firstUser);\n  } catch (e) {\n    console.error('Connection failed:', e);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/check_users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/SwaggerDocs.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[138,141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[138,141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport SwaggerUI from \"swagger-ui-react\";\nimport \"swagger-ui-react/swagger-ui.css\";\n\ntype Props = {\n  spec: Record<string, any>;\n};\n\nfunction SwaggerDocs({ spec }: Props) {\n  return <SwaggerUI spec={spec} />;\n}\n\nexport default SwaggerDocs;\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/chat-interface.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Plus' is defined but never used.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":6,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":42},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ImageIcon' is defined but never used.","line":6,"column":78,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":87},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChatSession' is defined but never used.","line":14,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":38,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1289,1292],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1289,1292],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":58,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":58,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2100,2103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2100,2103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":59,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":59,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2239,2242],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2239,2242],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":60,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":60,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2382,2385],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2382,2385],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":61,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":61,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":61,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":61,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2522,2525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2522,2525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":62,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2724,2727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2724,2727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":63,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":63,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2822,2825],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2822,2825],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":64,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":64,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2931,2934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2931,2934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":65,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":65,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":65,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3142,3145],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3142,3145],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":66,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":66,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":66,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":66,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3380,3383],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3380,3383],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'node' is defined but never used.","line":67,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":67,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3588,3591],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3588,3591],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":89,"column":15,"nodeType":"JSXOpeningElement","endLine":93,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentMediaBlob' is assigned a value but never used.","line":274,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":274,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'currentSelectedImage' is assigned a value but never used.","line":275,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":275,"endColumn":31},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleSendMessage'. Either include it or remove the dependency array.","line":334,"column":6,"nodeType":"ArrayExpression","endLine":334,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [handleSendMessage, mediaBlob]","fix":{"range":[12361,12372],"text":"[handleSendMessage, mediaBlob]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":401,"column":23,"nodeType":"JSXOpeningElement","endLine":405,"endColumn":25}],"suppressedMessages":[],"errorCount":11,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useRef, useEffect } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Plus, Send, Paperclip, Bot, User, Mic, Square, Loader2, X, Image as ImageIcon } from \"lucide-react\"\nimport ReactMarkdown from 'react-markdown'\nimport remarkGfm from 'remark-gfm'\nimport { Prism as SyntaxHighlighter } from 'react-syntax-highlighter'\nimport { oneDark, oneLight } from 'react-syntax-highlighter/dist/esm/styles/prism'\nimport { useMediaRecorder } from \"@/hooks/use-media-recorder\"\nimport { MobileMenuButton } from \"@/components/mobile-menu-button\"\nimport { useUser } from \"@clerk/nextjs\"\nimport { ChatSession } from \"@/lib/types\"\nimport { v4 as uuidv4 } from 'uuid'\n\n// --- 1. Types Definition ---\ntype Role = \"user\" | \"assistant\"\n\ninterface Message {\n  id: string\n  role: Role\n  content: string\n  timestamp: Date\n  citations?: string[]\n  fileUrl?: string\n  fileType?: \"image\" | \"voice\"\n}\n\n// --- 2. Sub-components ---\n\n// Component: Hiển thị một tin nhắn\nfunction MessageItem({ message }: { message: Message }) {\n  const isAI = message.role === \"assistant\"\n\n  // Cấu hình màu sắc khác nhau cho AI (nền sáng) và User (nền màu)\n  const components = {\n    code({ node, inline, className, children, ...props }: any) {\n      const match = /language-(\\w+)/.exec(className || '')\n      return !inline && match ? (\n        <SyntaxHighlighter\n          style={isAI ? oneDark : oneLight} // User dùng theme sáng cho code\n          language={match[1]}\n          PreTag=\"div\"\n          className=\"rounded-md my-2 shadow-sm border border-border\"\n          customStyle={{ backgroundColor: isAI ? '#1e1e1e' : '#ffffff', fontSize: '0.8rem' }}\n          {...props}\n        >\n          {String(children).replace(/\\n$/, '')}\n        </SyntaxHighlighter>\n      ) : (\n        <code className={`${className} px-1 py-0.5 rounded font-mono text-xs ${isAI ? \"bg-pink-100 text-pink-600\" : \"bg-blue-700 text-white border border-blue-500\"\n          }`} {...props}>\n          {children}\n        </code>\n      )\n    },\n    h1: ({ node, ...props }: any) => <h1 className={`text-lg font-bold mt-4 mb-2 ${isAI ? \"text-blue-600\" : \"text-white\"}`} {...props} />,\n    h2: ({ node, ...props }: any) => <h2 className={`text-base font-bold mt-3 mb-2 ${isAI ? \"text-indigo-600\" : \"text-white\"}`} {...props} />,\n    h3: ({ node, ...props }: any) => <h3 className={`text-sm font-bold mt-2 mb-1 ${isAI ? \"text-purple-600\" : \"text-white\"}`} {...props} />,\n    a: ({ node, ...props }: any) => <a className={`underline ${isAI ? \"text-blue-500 hover:text-blue-700\" : \"text-blue-100 hover:text-white\"}`} target=\"_blank\" rel=\"noopener noreferrer\" {...props} />,\n    ul: ({ node, ...props }: any) => <ul className=\"list-disc pl-4 my-2 space-y-1\" {...props} />,\n    ol: ({ node, ...props }: any) => <ol className=\"list-decimal pl-4 my-2 space-y-1\" {...props} />,\n    blockquote: ({ node, ...props }: any) => <blockquote className={`border-l-4 pl-4 py-1 my-2 italic ${isAI ? \"border-orange-400 bg-orange-50 text-muted-foreground\" : \"border-white/50 bg-white/10\"}`} {...props} />,\n    table: ({ node, ...props }: any) => <div className=\"overflow-x-auto my-2\"><table className={`min-w-full divide-y rounded-md ${isAI ? \"divide-border border border-border\" : \"divide-white/20 border border-white/20\"}`} {...props} /></div>,\n    th: ({ node, ...props }: any) => <th className={`px-3 py-2 text-left text-xs font-medium uppercase tracking-wider ${isAI ? \"bg-muted/50 text-muted-foreground\" : \"bg-white/10 text-white\"}`} {...props} />,\n    td: ({ node, ...props }: any) => <td className={`px-3 py-2 whitespace-nowrap text-sm ${isAI ? \"border-t border-border\" : \"border-t border-white/10\"}`} {...props} />,\n  }\n\n  return (\n    <div className={`flex w-full ${isAI ? \"justify-start\" : \"justify-end\"} px-4 py-2`}>\n      <div className={`max-w-[90%] lg:max-w-[80%] rounded-lg px-4 py-3 ${isAI\n        ? \"bg-muted/50 border border-border\"\n        : \"bg-primary text-primary-foreground\"\n        }`}>\n        <div className=\"flex items-center gap-2 mb-1\">\n          {isAI && <Bot className=\"w-4 h-4 opacity-70\" />}\n          <span className={`text-xs font-medium ${isAI ? \"opacity-70\" : \"opacity-90\"}`}>\n            {isAI ? \"Trợ lý Sutra\" : \"Bạn\"}\n          </span>\n          <span className={`text-[10px] ${isAI ? \"opacity-50\" : \"opacity-70\"}`}>\n            {new Date(message.timestamp).toLocaleTimeString(\"vi-VN\", { hour: \"2-digit\", minute: \"2-digit\" })}\n          </span>\n        </div>\n\n        <div className={`text-sm leading-relaxed overflow-hidden ${isAI ? \"markdown-body\" : \"\"}`}>\n          {message.fileUrl && message.fileType === \"image\" && (\n            <div className=\"mb-3\">\n              <img\n                src={message.fileUrl}\n                alt=\"Uploaded content\"\n                className=\"max-w-full rounded-lg border border-border/50 shadow-sm max-h-[300px] object-cover\"\n              />\n            </div>\n          )}\n\n          {message.fileUrl && message.fileType === \"voice\" && (\n            <div className=\"mb-3\">\n              <audio controls src={message.fileUrl} className=\"w-full max-w-[240px]\" />\n            </div>\n          )}\n\n          <ReactMarkdown\n            remarkPlugins={[remarkGfm]}\n            components={components}\n          >\n            {message.content}\n          </ReactMarkdown>\n        </div>\n\n        {isAI && message.citations && message.citations.length > 0 && (\n          <div className=\"mt-3 pt-3 border-t border-border/50\">\n            <p className=\"text-[10px] uppercase tracking-wider opacity-60 mb-2 font-semibold\">Nguồn tham khảo:</p>\n            <div className=\"flex flex-wrap gap-2\">\n              {message.citations.map((cite, idx) => (\n                <span key={idx} className=\"text-xs bg-background/50 px-2 py-1 rounded border border-border/50 flex items-center gap-1\">\n                  <Paperclip className=\"w-3 h-3\" /> {cite}\n                </span>\n              ))}\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\n// --- 3. Main Component ---\ninterface ChatInterfaceProps {\n  activeSessionId: string\n  onMessageSent: () => void\n}\n\nexport function ChatInterface({ activeSessionId, onMessageSent }: ChatInterfaceProps) {\n  const { user } = useUser()\n\n  // Media Recorder Hook\n  const { isRecording, mediaBlob, startRecording, stopRecording, clearRecording } = useMediaRecorder()\n\n  // Image Upload State\n  const [selectedImage, setSelectedImage] = useState<File | null>(null)\n  const imageInputRef = useRef<HTMLInputElement>(null)\n\n  // INIT MESSAGE\n  const [messages, setMessages] = useState<Message[]>([])\n\n  const [input, setInput] = useState(\"\")\n  const [isLoading, setIsLoading] = useState(false)\n  const messagesEndRef = useRef<HTMLDivElement>(null)\n\n  // Flag to trigger send after recording stops\n  const shouldSendAfterStop = useRef(false)\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\n  }\n\n  // --- Data Fetching ---\n\n  // Fetch Messages for Active Session\n  useEffect(() => {\n    const loadMessages = async () => {\n      if (!activeSessionId) return\n\n      // Optimistically set loading but don't clear messages immediately to avoid flash if switching quickly\n      setIsLoading(true)\n      // Reset messages if switching sessions, or keep them? better reset or have loading state\n      // setMessages([]) // Optional: clear previous messages\n\n      try {\n        const res = await fetch(`/api/chat/messages?session_id=${activeSessionId}`)\n        if (res.ok) {\n          const data = await res.json()\n          const messagesData = data.data || []\n          // If no messages found, it might be truly empty or new.\n          if (Array.isArray(messagesData) && messagesData.length > 0) {\n            setMessages(messagesData)\n          } else {\n            // Default welcome for empty/new\n            setMessages([{\n              id: \"welcome\",\n              role: \"assistant\",\n              content: \"Xin chào! Tôi là Trợ lý AI. Bạn cần giúp gì?\",\n              timestamp: new Date()\n            }])\n          }\n        }\n      } catch (e) {\n        console.error(\"Failed to fetch messages\", e)\n      } finally {\n        setIsLoading(false)\n      }\n    }\n\n    loadMessages()\n  }, [activeSessionId])\n\n  useEffect(() => {\n    scrollToBottom()\n  }, [messages])\n\n  const clearMedia = () => {\n    clearRecording()\n    setSelectedImage(null)\n    if (imageInputRef.current) imageInputRef.current.value = \"\"\n  }\n\n  const handleSendMessage = async () => {\n    // If recording, stop it and flag to send immediately after\n    if (isRecording) {\n      shouldSendAfterStop.current = true\n      stopRecording()\n      return\n    }\n\n    if ((!input.trim() && !mediaBlob && !selectedImage) || isLoading) return\n\n    setIsLoading(true)\n\n    const clientMessageId = uuidv4() // Generate unique ID for this specific message attempt\n\n    // Build FormData for n8n/API\n    const formData = new FormData()\n    formData.append(\"sessionId\", activeSessionId)\n    formData.append(\"clientMessageId\", clientMessageId) // <--- Add Deduplication ID\n    // Pass User ID if available, otherwise backend might fail or fallback\n    if (user?.id) formData.append(\"userId\", user.id)\n    console.log(\"User ID:\", user?.id)\n    console.log(\"Client Message ID:\", clientMessageId)\n\n    let userDisplayContent = \"\"\n\n    if (mediaBlob) {\n      formData.append(\"file\", mediaBlob, \"recording.webm\")\n      formData.append(\"type\", \"voice\")\n      userDisplayContent += \"🎤 [Ghi âm giọng nói]\"\n    } else if (selectedImage) {\n      formData.append(\"file\", selectedImage)\n      formData.append(\"type\", \"image\")\n      userDisplayContent += `🖼️ [Hình ảnh: ${selectedImage.name}]`\n    } else {\n      formData.append(\"type\", \"chat\")\n    }\n\n    if (input.trim()) {\n      formData.append(\"chatInput\", input)\n      userDisplayContent += userDisplayContent ? `\\n${input}` : input\n    }\n\n    // Optimistic UI Update\n    let fileUrl = undefined\n    let fileType: \"image\" | \"voice\" | undefined = undefined\n\n    if (mediaBlob) {\n      fileUrl = URL.createObjectURL(mediaBlob)\n      fileType = \"voice\"\n    } else if (selectedImage) {\n      fileUrl = URL.createObjectURL(selectedImage)\n      fileType = \"image\"\n    }\n\n    const userMessage: Message = {\n      id: Date.now().toString(),\n      role: \"user\",\n      content: userDisplayContent,\n      timestamp: new Date(),\n      fileUrl,\n      fileType\n    }\n    setMessages((prev) => [...prev, userMessage])\n    setInput(\"\")\n\n    // Clear media states immediately after sending (optimistic)\n    const currentMediaBlob = mediaBlob\n    const currentSelectedImage = selectedImage\n    clearMedia()\n\n    try {\n      // Use the n8n proxy route\n      const response = await fetch(\"/api/chat/n8n\", {\n        method: \"POST\",\n        body: formData, // fetch automatically sets Content-Type boundary\n      })\n\n      if (!response.ok) {\n        throw new Error(\"Failed to send message\")\n      }\n\n      const data = await response.json()\n\n      // Handle response - assume standard output structure\n      const aiContent = data.output || data.text || data.message || data.description || data.answer || JSON.stringify(data)\n\n      const assistantMessage: Message = {\n        id: (Date.now() + 1).toString(),\n        role: \"assistant\",\n        content: aiContent,\n        timestamp: new Date(),\n        citations: data.citations || []\n      }\n\n      setMessages((prev) => [...prev, assistantMessage])\n\n      // Notify parent to refresh session list (e.g. title might change)\n      if (onMessageSent) onMessageSent()\n\n    } catch (error) {\n      console.error(\"Chat error:\", error)\n      const errorMessage: Message = {\n        id: (Date.now() + 1).toString(),\n        role: \"assistant\",\n        content: \"Xin lỗi, tôi gặp lỗi khi xử lý yêu cầu. Vui lòng thử lại.\",\n        timestamp: new Date(),\n      }\n      setMessages((prev) => [...prev, errorMessage])\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      setSelectedImage(e.target.files[0])\n      clearRecording()\n    }\n  }\n\n  // Effect to handle \"Send to Stop\" logic\n  useEffect(() => {\n    if (mediaBlob && shouldSendAfterStop.current) {\n      shouldSendAfterStop.current = false\n      handleSendMessage()\n    }\n  }, [mediaBlob])\n\n  return (\n    <div className=\"flex h-full bg-background overflow-hidden\">\n      {/* Sidebar was removed from here */}\n\n      <div className=\"flex-1 flex flex-col min-w-0\">\n        <div className=\"border-b border-border p-3 md:p-6\">\n          <div className=\"flex items-start gap-3\">\n            {/* Mobile Menu Button - integrated with title */}\n            <MobileMenuButton className=\"-ml-1 mt-0.5\" />\n\n            <div className=\"flex-1 min-w-0\">\n              <h2 className=\"text-xl md:text-2xl font-bold text-foreground\">Trợ lý Đa phương thức</h2>\n              <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">Hỗ trợ Chat, Voice (Whisper) và Nhận diện ảnh (OCR)</p>\n              <div className=\"flex items-center gap-2 mt-1\">\n                <span className=\"text-[10px] md:text-xs text-muted-foreground/50 truncate max-w-[200px] md:max-w-none\">Session ID: {activeSessionId}</span>\n                <div className={`w-2 h-2 rounded-full shrink-0 ${isLoading ? \"bg-yellow-400 animate-pulse\" : \"bg-green-400\"}`} />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex-1 overflow-y-auto scroll-smooth\">\n          {messages.length === 0 ? (\n            <div className=\"h-full flex flex-col items-center justify-center text-center p-8 text-muted-foreground\">\n              <Bot className=\"w-12 h-12 mb-4 opacity-20\" />\n              <h3 className=\"text-lg font-medium text-foreground mb-2\">Tôi có thể giúp gì cho bạn hôm nay?</h3>\n            </div>\n          ) : (\n            <div className=\"flex flex-col py-4 space-y-4\">\n              {messages.map(msg => (\n                <MessageItem key={msg.id} message={msg} />\n              ))}\n              {isLoading && (\n                <div className=\"flex justify-start px-4\">\n                  <div className=\"bg-muted/50 border border-border rounded-lg px-4 py-3 flex items-center gap-2\">\n                    <Bot className=\"w-4 h-4 opacity-70\" />\n                    <Loader2 className=\"w-3 h-3 animate-spin\" />\n                    <span className=\"text-xs text-muted-foreground\">Đang xử lý đa phương thức...</span>\n                  </div>\n                </div>\n              )}\n              <div ref={messagesEndRef} />\n            </div>\n          )}\n        </div>\n\n        <div className=\"border-t border-border p-3 md:p-6 bg-card\">\n          {/* Media Previews */}\n          {(mediaBlob || selectedImage) && (\n            <div className=\"mb-4 p-3 bg-muted/30 border border-border rounded-lg flex items-center justify-between\">\n              <div className=\"flex items-center gap-3 w-full overflow-hidden\">\n                {mediaBlob && (\n                  <div className=\"flex items-center gap-3 w-full\">\n                    <div className=\"relative\">\n                      <Mic className=\"w-5 h-5 text-red-500 animate-pulse\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-xs font-medium mb-1\">Ghi âm: {(mediaBlob.size / 1024).toFixed(1)} KB</p>\n                      <audio controls src={URL.createObjectURL(mediaBlob)} className=\"w-full h-8\" />\n                    </div>\n                  </div>\n                )}\n                {selectedImage && (\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"relative w-16 h-16 rounded overflow-hidden border border-border\">\n                      <img\n                        src={URL.createObjectURL(selectedImage)}\n                        alt=\"Preview\"\n                        className=\"w-full h-full object-cover\"\n                      />\n                    </div>\n                    <div>\n                      <span className=\"text-sm font-medium block\">{selectedImage.name}</span>\n                      <span className=\"text-xs text-muted-foreground\">{(selectedImage.size / 1024).toFixed(1)} KB</span>\n                    </div>\n                  </div>\n                )}\n              </div>\n              <button onClick={clearMedia} className=\"p-2 hover:bg-muted rounded-full shrink-0 ml-2\">\n                <X className=\"w-4 h-4 opacity-70\" />\n              </button>\n            </div>\n          )}\n\n          <div className=\"flex gap-2 md:gap-3\">\n            {/* Image Upload Input (Hidden) */}\n            <input\n              type=\"file\"\n              accept=\"image/*\"\n              className=\"hidden\"\n              ref={imageInputRef}\n              onChange={handleImageSelect}\n            />\n\n            <button\n              onClick={() => imageInputRef.current?.click()}\n              className={`p-3 md:p-2 rounded-lg transition-colors min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 flex items-center justify-center ${selectedImage ? \"bg-blue-100 text-blue-600\" : \"hover:bg-muted text-muted-foreground\"}`}\n              title=\"Tải ảnh lên\"\n            >\n              <Paperclip className=\"w-5 h-5\" />\n            </button>\n\n            {/* Voice Recorder Button */}\n            {/* Voice Recorder Button */}\n            <button\n              onClick={isRecording ? stopRecording : startRecording}\n              className={`p-3 md:p-2 rounded-lg transition-colors min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 flex items-center justify-center ${isRecording ? \"bg-red-100 text-red-600 animate-pulse border border-red-200\" : \"hover:bg-muted text-muted-foreground\"}`}\n              title={isRecording ? \"Dừng ghi âm\" : \"Nhấn để ghi âm\"}\n            >\n              {isRecording ? (\n                <Square className=\"w-5 h-5 fill-current\" />\n              ) : (\n                <Mic className=\"w-5 h-5\" />\n              )}\n            </button>\n\n            <Input\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              onKeyPress={(e) => e.key === \"Enter\" && handleSendMessage()}\n              placeholder=\"Nhập tin nhắn...\"\n              className=\"flex-1 min-h-[44px]\"\n              disabled={isLoading || isRecording}\n            />\n            <Button\n              onClick={handleSendMessage}\n              disabled={isLoading || (!input.trim() && !mediaBlob && !selectedImage && !isRecording)}\n              className=\"bg-primary hover:bg-primary/90 min-w-[44px] min-h-[44px] md:min-w-0 md:min-h-0 px-3 md:px-4\"\n            >\n              <Send className=\"w-5 h-5\" />\n            </Button>\n          </div>\n          <div className=\"text-[10px] md:text-xs text-muted-foreground/40 mt-2 text-center\">\n            Nhấn Microphone để bắt đầu/dừng ghi âm • Chọn Paperclip để gửi ảnh\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/customers-panel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/home-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/knowledge-portal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/mobile-menu-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/mobile-menu-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/reports-panel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/scheduling-panel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/storage-panel.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchInventory'. Either include it or remove the dependency array.","line":50,"column":6,"nodeType":"ArrayExpression","endLine":50,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [fetchInventory, searchQuery]","fix":{"range":[1258,1271],"text":"[fetchInventory, searchQuery]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useEffect } from \"react\"\nimport { Search, Loader2, Package, Archive, AlertCircle } from \"lucide-react\"\nimport { Input } from \"@/components/ui/input\"\nimport { MobileMenuButton } from \"@/components/mobile-menu-button\"\n\ninterface InventoryItem {\n  id: string\n  item_code: string\n  name: string\n  unit: string\n  quantity: number\n  details: {\n    opening: number\n    in: number\n    out: number\n  }\n}\n\nexport function StoragePanel() {\n  const [items, setItems] = useState<InventoryItem[]>([])\n  const [isLoading, setIsLoading] = useState(true)\n  const [searchQuery, setSearchQuery] = useState(\"\")\n\n  const fetchInventory = async () => {\n    setIsLoading(true)\n    try {\n      const params = new URLSearchParams()\n      if (searchQuery) params.append(\"search\", searchQuery)\n\n      const res = await fetch(`/api/inventory?${params.toString()}`)\n      if (res.ok) {\n        const data = await res.json()\n        setItems(data.data || [])\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch inventory\", error)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  useEffect(() => {\n    // Debounce search\n    const timer = setTimeout(() => {\n      fetchInventory()\n    }, 500)\n    return () => clearTimeout(timer)\n  }, [searchQuery])\n\n  return (\n    <div className=\"flex flex-col h-full bg-background\">\n      {/* Header */}\n      <div className=\"border-b border-border p-3 md:p-6\">\n        <div className=\"flex items-start gap-3\">\n          <MobileMenuButton className=\"-ml-1 mt-0.5\" />\n\n          <div className=\"flex-1 min-w-0\">\n            <h2 className=\"text-xl md:text-2xl font-bold text-foreground flex items-center gap-2\">\n              <Package className=\"w-6 h-6 text-primary\" />\n              Quản lý Tồn kho\n            </h2>\n            <p className=\"text-xs md:text-sm text-muted-foreground mt-1\">\n              Theo dõi biến động tồn kho thực tế theo thời gian thực\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"flex-1 overflow-hidden flex flex-col p-4 md:p-6\">\n        {/* Search */}\n        <div className=\"mb-4 relative max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Tìm kiếm theo mã, tên vật tư...\"\n            className=\"pl-9\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n          />\n        </div>\n\n        {/* Table */}\n        <div className=\"flex-1 overflow-auto border rounded-md bg-card shadow-sm\">\n          <table className=\"w-full text-sm text-left\">\n            <thead className=\"bg-muted text-muted-foreground font-medium sticky top-0 z-10\">\n              <tr>\n                <th className=\"p-3 w-32\">Mã SP</th>\n                <th className=\"p-3\">Tên sản phẩm / Model</th>\n                <th className=\"p-3 w-24 text-center\">Đơn vị</th>\n                <th className=\"p-3 w-32 text-right\">Tồn kho</th>\n                <th className=\"p-3 w-40 text-right hidden lg:table-cell text-muted-foreground/70 font-normal\">Đầu kỳ</th>\n                <th className=\"p-3 w-40 text-right hidden lg:table-cell text-green-600/70 font-normal\">Nhập</th>\n                <th className=\"p-3 w-40 text-right hidden lg:table-cell text-red-600/70 font-normal\">Xuất</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-border\">\n              {isLoading ? (\n                <tr>\n                  <td colSpan={7} className=\"p-10 text-center text-muted-foreground\">\n                    <Loader2 className=\"w-8 h-8 animate-spin mx-auto mb-3 text-primary/50\" />\n                    Đang tải dữ liệu tồn kho...\n                  </td>\n                </tr>\n              ) : items.length === 0 ? (\n                <tr>\n                  <td colSpan={7} className=\"p-10 text-center text-muted-foreground flex flex-col items-center\">\n                    <Archive className=\"w-10 h-10 mb-2 opacity-20\" />\n                    <p>Không tìm thấy sản phẩm nào trong kho.</p>\n                  </td>\n                </tr>\n              ) : (\n                items.map((item) => (\n                  <tr key={item.id} className=\"hover:bg-muted/50 transition-colors group\">\n                    <td className=\"p-3 font-medium text-primary\">{item.item_code}</td>\n                    <td className=\"p-3 font-medium\">{item.name}</td>\n                    <td className=\"p-3 text-center text-muted-foreground\">{item.unit}</td>\n                    <td className={`p-3 text-right font-bold ${item.quantity <= 5 ? 'text-red-500' : 'text-foreground'}`}>\n                      {item.quantity}\n                      {item.quantity <= 5 && (\n                        <AlertCircle className=\"w-3 h-3 inline-block ml-1 -mt-0.5 text-red-500\" />\n                      )}\n                    </td>\n                    {/* Details columns for large screens */}\n                    <td className=\"p-3 text-right hidden lg:table-cell text-muted-foreground\">{item.details.opening}</td>\n                    <td className=\"p-3 text-right hidden lg:table-cell text-green-600\">+{item.details.in}</td>\n                    <td className=\"p-3 text-right hidden lg:table-cell text-red-600\">-{item.details.out}</td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/theme-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/ui/button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/ui/dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/ui/input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/components/users-panel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/hooks/use-media-recorder.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/api-helper.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[130,133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[130,133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\";\nimport { Prisma } from \"@prisma/client\";\n\nexport async function handleApiError(error: any, contextStr: string = \"API Error\") {\n  console.error(`[${contextStr}]`, error);\n\n  // Prisma Connection Error\n  if (\n    error instanceof Prisma.PrismaClientInitializationError ||\n    error instanceof Prisma.PrismaClientKnownRequestError\n  ) {\n    // Check for specific connection issues or general initialization failures\n    // Note: error.message usually contains \"Can't reach database server\"\n    if (error.message.includes(\"Can't reach database server\")) {\n      return NextResponse.json(\n        {\n          error: \"Service Temporarily Unavailable\",\n          details: \"Database connection failed. Please try again later.\"\n        },\n        { status: 503 }\n      );\n    }\n  }\n\n  return NextResponse.json(\n    { error: \"Internal Server Error\", details: error.message || \"Unknown error\" },\n    { status: 500 }\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/auth-utils.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":19,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[662,665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[662,665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[749,752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[749,752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3566,3569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3566,3569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":180,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5953,5956],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5953,5956],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":184,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6138,6141],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6138,6141],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { auth, clerkClient } from \"@clerk/nextjs/server\";\nimport { db } from \"@/lib/db\";\nimport { user_role_enum } from \"@prisma/client\";\nimport { cache } from \"react\";\n\n/**\n * Get current authenticated user with role information from database\n * Auto-creates user in database if they don't exist (syncs from Clerk)\n */\nexport const getCurrentUserWithRole = cache(async () => {\n  const { userId, sessionClaims } = await auth();\n\n  if (!userId) {\n    return null;\n  }\n\n  // Use session claims if available to avoid DB query\n  // Note: These must be configured in Clerk Dashboard -> Sessions -> Edit Session Claims\n  const role = (sessionClaims?.publicMetadata as any)?.role as user_role_enum;\n  const departmentId = (sessionClaims?.publicMetadata as any)?.department_id as string | undefined;\n\n  // Optimization: If info is in claims, we can return early to avoid a DB trip\n  // For now, let's only skip if we HAVE role and department info (or if it's null).\n  // We'll still fetch from DB if we need full_name/email, but many APIs don't.\n  // Actually, to be safe and compatible with existing code expecting a full object:\n  /* if (role) {\n    return { id: userId, role, department_id: departmentId, ... };\n  } */\n\n  // If we have role and departmentId from claims, and we also have email and full_name from claims,\n  // we can construct a user object and return early.\n  // This avoids a DB query for common use cases where only these fields are needed.\n  if (role && sessionClaims?.email && sessionClaims?.fullName) {\n    return {\n      id: userId,\n      email: sessionClaims.email,\n      full_name: sessionClaims.fullName,\n      role: role,\n      department_id: departmentId || null,\n      // Note: The 'departments' object (with id and name) is not available from claims.\n      // If that's needed, the DB query is still required.\n      departments: departmentId ? { id: departmentId, name: \"Unknown Department (from claims)\" } : null,\n    };\n  }\n\n  // Try to find user in database\n  let user = await db.users.findUnique({\n    where: { id: userId },\n    select: {\n      id: true,\n      email: true,\n      full_name: true,\n      role: true,\n      department_id: true,\n      departments: {\n        select: {\n          id: true,\n          name: true,\n        },\n      },\n    },\n  });\n\n  // If user doesn't exist in DB, create them automatically from Clerk data\n  if (!user) {\n    try {\n      console.log(`⚠️ User ${userId} not found in database, fetching from Clerk...`);\n\n      const client = await clerkClient();\n      const clerkUser = await client.users.getUser(userId);\n\n      const email = clerkUser.emailAddresses[0]?.emailAddress || '';\n      const fullName = `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim();\n      const role = (clerkUser.publicMetadata?.role as string) || 'NOT_ASSIGN';\n      const departmentId = clerkUser.publicMetadata?.department_id as string | undefined;\n\n      user = await db.users.create({\n        data: {\n          id: userId,\n          email: email,\n          full_name: fullName || email, // Fallback to email if no name\n          role: role as user_role_enum,\n          department_id: departmentId || null,\n        },\n        select: {\n          id: true,\n          email: true,\n          full_name: true,\n          role: true,\n          department_id: true,\n          departments: {\n            select: {\n              id: true,\n              name: true,\n            },\n          },\n        },\n      });\n\n      console.log(`✅ Auto-created user ${userId} in database with role: ${role}`);\n    } catch (error: any) {\n      if (error.code === 'P2002' && error.meta?.target?.includes('email')) {\n        console.error(`❌ Auto-create failed: Email already exists.`);\n\n        // Attempt to find the conflicting user to show details\n        const email = (await (await clerkClient()).users.getUser(userId)).emailAddresses[0]?.emailAddress;\n        const conflictingUser = await db.users.findUnique({ where: { email } });\n\n        console.error(`CONFLICT: Email '${email}' is already used by existing User ID: ${conflictingUser?.id}`);\n        console.error(`SOLUTION: Delete the old user from the database or update their ID.`);\n      } else {\n        console.error(`❌ Failed to auto-create user ${userId}:`, error);\n      }\n      return null;\n    }\n  }\n\n  return user;\n});\n\n/**\n * Check if current user has one of the allowed roles\n * @throws Error if user is not authenticated or doesn't have required role\n */\nexport async function requireRole(allowedRoles: user_role_enum[]) {\n  const user = await getCurrentUserWithRole();\n\n  if (!user) {\n    throw new Error(\"Unauthorized: User not authenticated\");\n  }\n\n  if (!allowedRoles.includes(user.role)) {\n    throw new Error(\n      `Forbidden: User role '${user.role}' is not authorized. Required: ${allowedRoles.join(\", \")}`\n    );\n  }\n\n  return user;\n}\n\n/**\n * Check if user can assign job to a technician\n * Admin can assign to anyone, Manager can only assign to their department\n */\nexport async function canAssignToTechnician(\n  currentUser: Awaited<ReturnType<typeof getCurrentUserWithRole>>,\n  technicianId: string\n): Promise<boolean> {\n  if (!currentUser) return false;\n\n  // Admin can assign to anyone\n  if (currentUser.role === \"Admin\") {\n    return true;\n  }\n\n  // Manager can only assign to technicians in their department\n  if (currentUser.role === \"Manager\") {\n    const technician = await db.users.findUnique({\n      where: { id: technicianId },\n      select: { department_id: true, role: true },\n    });\n\n    if (!technician || technician.role !== \"Technician\") {\n      return false;\n    }\n\n    return technician.department_id === currentUser.department_id;\n  }\n\n  return false;\n}\n\n/**\n * Filter financial data from job object for Technician role\n */\nexport function sanitizeJobForTechnician(job: unknown) {\n  if (!job || typeof job !== 'object') return job;\n\n  // Remove financial fields\n  const sanitized = { ...(job as Record<string, any>) };\n\n  // Remove line items pricing\n  if (sanitized.job_line_items && Array.isArray(sanitized.job_line_items)) {\n    sanitized.job_line_items = sanitized.job_line_items.map((item: any) => ({\n      ...item,\n      unit_price: undefined,\n      materials_and_services: item.materials_and_services\n        ? {\n          ...item.materials_and_services,\n          price: undefined,\n        }\n        : undefined,\n    }));\n  }\n\n  return sanitized;\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/n8n.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[247,250],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[247,250],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Hàm helper để gọi Webhook của n8n\n * @param webhookPath Đường dẫn webhook (phần sau domain), ví dụ: 'new-job-report'\n * @param payload Dữ liệu JSON cần gửi sang n8n\n */\nexport async function triggerN8nWorkflow(webhookPath: string, payload: any) {\n  // URL gốc của n8n (Lấy từ biến môi trường)\n  const n8nHost = process.env.N8N_HOST;\n\n  if (!n8nHost) {\n    console.warn(\"N8N_HOST is not defined in .env. Skipping n8n trigger.\");\n    return;\n  }\n\n  // Ghép thành URL hoàn chỉnh: https://n8n.../webhook/new-job-report\n  // Đảm bảo không bị duplicate dấu slash\n  const baseUrl = n8nHost.endsWith('/') ? n8nHost.slice(0, -1) : n8nHost;\n  const path = webhookPath.startsWith('/') ? webhookPath.slice(1) : webhookPath;\n  const url = `${baseUrl}/webhook/${path}`;\n\n  try {\n    console.log(`[N8N Trigger] Sending data to ${url}`);\n\n    // Gọi n8n (Fire and Forget - hoặc await tùy nhu cầu)\n    // Ở đây tôi dùng await nhưng catch lỗi để không làm crash luồng chính\n    const response = await fetch(url, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        // Nếu n8n của bạn có set authentication header, thêm vào đây\n        // \"X-N8N-API-KEY\": process.env.N8N_API_KEY \n      },\n      body: JSON.stringify(payload),\n    });\n\n    if (!response.ok) {\n      console.error(`[N8N Error] Failed to trigger workflow: ${response.status} ${response.statusText}`);\n    } else {\n      console.log(\"[N8N Success] Workflow triggered successfully\");\n    }\n  } catch (error) {\n    console.error(\"[N8N Exception] Error calling n8n:\", error);\n  }\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/pagination.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/swagger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/lib/utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/prisma/seed_inventory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/scripts/fix-user-conflict.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/scripts/list_users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/scripts/set_admin.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/scripts/sync_clerk_users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/quan/Downloads/Agent-AI/scripts/truncate_tables.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
